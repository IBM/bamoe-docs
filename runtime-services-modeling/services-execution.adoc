= Using _Business Services_
include::../partials/attributes.adoc[]
include::../styles/images.adoc[]

[role="_abstract"]

// tag::con-kogito-service-execution[]
[id="con-kogito-service-execution"]

[role="_abstract"]
After you design your _Business Service_, you can build and run your application, sending REST API requests to the application to execute your services. The exact REST API requests that you can use depend on how you set up the application.

For example, consider a _Business Service_ that is set up to generate a `/persons` REST API endpoint and that determines whether a specified customer is an adult or is underage. In this example, you can send the following `POST` request using a REST client or curl utility to add an adult and execute the service:

---

== Running the {PRODUCT} decision example applications

[role="_abstract"]
To get started with {PRODUCT}, you can run any of the example applications in the bamoe-{VERSION}-kogito-examples.zip archive and experiment with the _Business Services_.

For this procedure, use the `process-decisions-quarkus` application. You can follow similar steps with the other {PRODUCT} examples on Quarkus.

In the `process-decisions-quarkus` applications, the `traffic-rules-dmn.bpmn` process describes the steps that need to be followed when verifying a driver's potential suspension.
The process includes a service node to call to a Java service `DriverService.java` that is used to fetch information about a driver using a custom `Driver` object, Business Rule nodes to call decisions defined in `DMN` and `DRL` format as well as script tasks for writing debug information.

.Example `traffic-rules-dmn.bpmn` process
image::traffic-rules-dmn.png[Image of `traffic-rules-dmn.bpmn` example process]

The traffic violations process contains license validation as a decision that is created using DRL. The license validation consists of rules that are evaluated to verify that the license is expired or not. The result of the license validation is added for the driver variable. The rule units are declared in the `LicenseValidationService.drl` file and the rule unit data is added to the `LicenseValidationService` class.

Example `LicenseValidationService.drl` file:
[source,subs="attributes+"]
----
unit LicenseValidationService

rule "Is driver license valid"
when
$driver: /driver[licenseExpiration.after(currentTime)]
then
$driver.setValidLicense(true);
end

rule "Is driver license expired"
when
$driver: /driver[licenseExpiration.before(currentTime)]
then
$driver.setValidLicense(false);
end

query "validation"
$driver : /driver
end
----

Example `LicenseValidationService` class:
[source,java]
----
public class LicenseValidationService implements RuleUnitData {
private SingletonStore<Driver> driver;

    public LicenseValidationService() {
        this(DataSource.createSingleton());
    }

    public LicenseValidationService(SingletonStore<Driver> driver) {
        this.driver = driver;
    }

    public void setDriver(SingletonStore<Driver> driver) {
        this.driver = driver;
    }

    public SingletonStore<Driver> getDriver() {
        return driver;
    }

    public Date getCurrentTime() {
        return new Date();
    }
}
----

After the license validation task, the traffic violations process contains traffic violation as a decision that is created using DMN. The traffic violation decision verifies whether the driver is suspended or not based on the points in the driverâ€™s license.

The traffic violation decision is declared in the `TrafficViolation.dmn` file.

.Example `TrafficViolation.dmn` file
image::traffic-violation-dmn.png[Image of traffic TrafficViolation.dmn file]

Based on this process, this example service exposes REST operations to create new traffic incidents, to list and delete active traffic incidents, and to invoke the license validation service endpoint.

.Procedure
. Download the bamoe-{VERSION}-kogito-examples.zip archive to a local directory and extract the file.
. In a command terminal, navigate to the extracted `kogito-quarkus-examples/process-decisions-quarkus` folder, and enter one of the following commands to build and run the example.

Quarkus support the following run modes:

* *Development mode*: For local testing. On Quarkus, development mode also offers live reload of your processes and decisions in your running applications for advanced debugging.
* *JVM mode*: For compatibility with a Java virtual machine (JVM).
* *Native mode*: (Quarkus only, requires GraalVM or Mandrel) For direct binary execution as native code.

The command that you use depends on your preferred run mode and application environment:

* For development mode:
+
.On Quarkus
[source]
----
mvn clean compile quarkus:dev
----
+
* For JVM mode:
+
.On Quarkus
[source]
----
mvn clean package
java -jar target/quarkus-app/quarkus-run.jar
----
+
* For native mode (requires GraalVM or Mandrel):
+
.On Quarkus only
[source]
----
mvn clean package -Dnative
./target/process-decisions-quarkus-runner
----

[start=3]
. After the _Business Service_ is running, use a REST client, curl utility, or the Swagger UI configured for the application - http://localhost:8080/q/swagger-ui - to send API requests with the following components:

* *URL*: `\http://localhost:8080/`
* *HTTP headers*: For `POST` and `PUT` requests only:
** `accept`: `application/json`
** `content-type`: `application/json`
* *HTTP methods*: `GET`, `POST`, `PUT` or `DELETE`

.Example POST request body to create a traffic incident (JSON)
[source,json]
----
{
    "driverId": "12345",
    "violation":{
        "Type":"speed",
        "Speed Limit": 100,
        "Actual Speed":140
    }
}
----

.Example curl command to create a traffic incident
[source]
----
curl -X POST -H 'Content-Type:application/json' -H 'Accept:application/json' -d '{"driverId": "12345","violation":{"Type":"speed","Speed Limit": 100,"Actual Speed":140}}' http://localhost:8080/traffic
----

.Example response (JSON)
[source,json]
----
{
   "driver" : {
      "Age" : 30,
      "City" : "Campinas",
      "Name" : "Arthur",
      "Points" : 13,
      "State" : "SP",
      "licenseExpiration" : "2023-06-15T11:02:17.610-06:00",
      "validLicense" : true
   },
   "driverId" : "12345",
   "fine" : {
      "Amount" : 1000,
      "Points" : 7
   },
   "id" : "d9ac9587-40dc-4f0b-8034-274db5bca832",
   "suspended" : "Yes",
   "violation" : {
      "Actual Speed" : 140,
      "Code" : null,
      "Date" : null,
      "Speed Limit" : 100,
      "Type" : "speed"
   }
}
----

.Swagger UI to interact with all application endpoints - \http://localhost:8080/q/swagger-ui
image::kogito-swagger-example-jbpm.png[Image of Swagger UI for example application]

[NOTE]
====
For the predefined {PRODUCT} example applications, by default the Swagger UI is only available when Quarkus is started in dev or test mode. If you want to make it available in production too, you can include the following configuration in your `application.properties`:
[source]
----
quarkus.swagger-ui.always-include=true
----
This is a build time property, it cannot be changed at runtime after your application is built.
====




---

[id="proc-kogito-interacting-app"]
== Interacting with a running _Business Service_

[role="_abstract"]
After your _Business Service_ is running, you can send REST API requests to interact with your application and execute your services according to how you set up the application.

This example tests the `/persons` REST API endpoint that is automatically generated based on the `PersonProcess.bpmn2` business process, according to the decisions in the `PersonDecisions.dmn` file (or the rules in the `PersonRules.drl` file if you used a DRL rule unit).

For this example, use a REST client, curl utility, or the Swagger UI configured for the application (such as \http://localhost:8080/q/swagger-ui or \http://localhost:8080/swagger-ui.html) to send API requests with the following components:

* *URL*: `\http://localhost:8080/persons`
* *HTTP headers*: For `POST` requests only:
** `accept`: `application/json`
** `content-type`: `application/json`
* *HTTP methods*: `GET`, `POST`, or `DELETE`

.Example POST request body to add an adult (JSON)
[source,json]
----
{
  "person": {
    "name": "John Quark",
    "age": 20
  }
}
----

.Example curl command to add an adult
[source]
----
curl -X POST http://localhost:8080/persons -H 'content-type: application/json' -H 'accept: application/json' -d '{"person": {"name":"John Quark", "age": 20}}'
----

.Example response (JSON)
[source,json]
----
{
  "id": "3af806dd-8819-4734-a934-728f4c819682",
  "person": {
    "name": "John Quark",
    "age": 20,
    "adult": false
  },
  "isAdult": true
}
----

.Swagger UI to interact with all application endpoints (such as \http://localhost:8080/q/swagger-ui or \http://localhost:8080/swagger-ui.html)
image::kogito-swagger-example.png[Image of Swagger UI for example application]

This example procedure uses curl commands for convenience.

.Procedure
In a command terminal window that is separate from your running application, navigate to the project that contains your _Business Service_ and use any of the following curl commands with JSON requests to interact with your running service:

* Add an adult person:
+
--
.Example request
[source]
----
curl -X POST http://localhost:8080/persons -H 'content-type: application/json' -H 'accept: application/json' -d '{"person": {"name":"John Quark", "age": 20}}'
----

.Example response
[source]
----
{"id":"3af806dd-8819-4734-a934-728f4c819682","person":{"name":"John Quark","age":20,"adult":false},"isAdult":true}
----
--
* Add an underage person:
+
--
.Example request
[source]
----
curl -X POST http://localhost:8080/persons -H 'content-type: application/json' -H 'accept: application/json' -d '{"person": {"name":"Jenny Quark", "age": 15}}'
----

.Example response
[source]
----
{"id":"8eef502b-012b-4628-acb7-73418a089c08","person":{"name":"Jenny Quark","age":15,"adult":false},"isAdult":false}
----
--
* View active process instances:
+
--
.Example request
[source]
----
curl -X GET http://localhost:8080/persons -H 'content-type: application/json' -H 'accept: application/json'
----

.Example response
[source]
----
[{"id":"8eef502b-012b-4628-acb7-73418a089c08","person":{"name":"Jenny Quark","age":15,"adult":false},"isAdult":false}]
----
--
* View process instance details using the returned process UUID:
+
--
.Example request
[source]
----
curl -X GET http://localhost:8080/persons/8eef502b-012b-4628-acb7-73418a089c08/tasks -H 'content-type: application/json' -H 'accept: application/json'
----

.Example response (JSON)
[source]
----
{"cdec4241-d676-47de-8c55-4ee4f9598bac":"ChildrenHandling"}
----
--
* View task instance details using the returned process and task UUIDs:
+
--
.Example request
[source]
----
curl -X GET http://localhost:8080/persons/8eef502b-012b-4628-acb7-73418a089c08/ChildrenHandling/cdec4241-d676-47de-8c55-4ee4f9598bac -H 'content-type: application/json' -H 'accept: application/json'
----

.Example response
[source]
----
{"person":{"name":"Jenny Quark","age":15,"adult":false},"name":"ChildrenHandling","id":"cdec4241-d676-47de-8c55-4ee4f9598bac"}
----
--
* Complete the evaluation using the returned UUIDs:
+
--
.Example request
[source]
----
curl -X POST http://localhost:8080/persons/8eef502b-012b-4628-acb7-73418a089c08/ChildrenHandling/cdec4241-d676-47de-8c55-4ee4f9598bac -H 'content-type: application/json' -H 'accept: application/json' -d '{}'
----
--

