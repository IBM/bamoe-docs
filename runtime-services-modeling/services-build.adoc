= Building Business Services
include::../partials/attributes.adoc[]

[id="proc-kogito-creating-project"]
== Creating a Maven project for a {PRODUCT} service using {CANVAS}

[role="_abstract"]
Before you can begin developing {PRODUCT} services, you need to create a Maven project where you can build your {PRODUCT} assets and any other related resources for your application.

.Procedure
. Run {CANVAS} - see the xref:../installation/canvas.adoc[installation] chapter for more details on how to install and run it.
. If you do not already have a project or an asset file, create a DMN or BPMN file.
. Use the xref:../tools/applying-accelerators.adoc[Accelerators] functionality in {CANVAS} to create a project that is buildable and deployable.


== Building the project
.Procedure
. Download the (project).zip archive to a local directory and extract the file.
. In a command terminal, navigate to the extracted folder, and enter one of the following commands to build the project.

Quarkus support the following building modes:

* *JVM mode*: For compatibility with a Java virtual machine (JVM).
* *Native mode*: (Quarkus only, requires GraalVM or Mandrel) For direct binary execution as native code.

The command that you use depends on your preferred run mode and application environment:

* For JVM mode:
+
.On Quarkus
[source]
----
$ mvn clean package
----
+
* For native mode (requires GraalVM or Mandrel):
+
.On Quarkus only
[source]
----
$ mvn clean package -Dnative
----

== {PRODUCT} add-ons

You can extend {PRODUCT} core capabilities by using add-ons modules. The add-on modules extend monitoring, messaging, and other features of {PRODUCT} services.

The following tables list all the supported add-ons in {PRODUCT}:

.{PRODUCT} add-ons for Quarkus
[cols=2]
|===
|Name
|Artifact Id

|Messaging
|kie-addons-quarkus-messaging

|Events Decisions
|kie-addons-quarkus-events-decisions

|Events Process
|kie-addons-quarkus-events-process

|Knative Eventing
|kie-addons-quarkus-knative-eventing

|Mail
|jbpm-addons-quarkus-mail

|Elastic Monitoring
|kie-addons-quarkus-monitoring-elastic

|Prometheus Monitoring
|kie-addons-quarkus-monitoring-prometheus

|Tracing Decision
|kogito-addons-quarkus-tracing-decision

|Source Files
|kie-addons-quarkus-source-files
|===

=== {PRODUCT} messaging add-on

{PRODUCT} provides a messaging add-on, enabling a process to register an event listener. The messaging add-on uses events in the {PRODUCT} projects. 

To configure messaging capabilities for your Business Services, you must add the messaging add-on as a dependency in the `pom.xml` file of your project:

.Project dependency to enable messaging operations in Quarkus projects
[source,xml,subs="attributes+"]
----
<dependency>
  <groupId>org.kie</groupId>
  <artifactId>kie-addons-quarkus-messaging</artifactId>
</dependency>
----

For Quarkus, the {PRODUCT} process event add-on implementation is based on https://smallrye.io/smallrye-reactive-messaging/smallrye-reactive-messaging/2/connectors/connectors.html[Smallrye Messaging] library, which provides a set of connectors for event brokers, such as JMS, AMQP, and Kafka. Therefore, the {PRODUCT} process event add-on is not specifically combined with any event broker, but also requires additional configuration to use a suitable Smallrye connector.

For example, to use Kafka as an event broker in Quarkus, you must add the following dependency in the `pom.xml` file of your {PRODUCT} project:

.Project dependency to enable event broker in Quarkus
[source,xml,subs="attributes+"]
----
<dependency>
  <groupId>io.quarkus</groupId>
  <artifactId>quarkus-smallrye-reactive-messaging-kafka</artifactId>
</dependency>
----

Smallrye uses an abstraction named `channel`. The implementation of channels depends on the underlying event broker. For example, when using Kafka, every channel is mapped to a topic. 

Channels are configured by using properties. The pattern for these properties is `mp.messaging.[incoming|outgoing].<channel name>.<property_name>`.

{PRODUCT} allows different channel mapping strategies:

* Define one default incoming channel to receive all the incoming messages and one default outgoing channel to store all the published messages.
* Define a channel for each message name so that every message type has a dedicated channel.
* Define a channel for certain message names and let the not mapped message names to use the default incoming or outgoing channel. 

{PRODUCT} first searches for channel name equals to message name in the properties. If found, it uses that channel for that message name. If not, it searches for default channel definition. If also not existing, then an error will be reported. 

The name for the default incoming channel is `kogito_incoming_stream` and for the default outgoing channel is `kogito_outgoing_stream`. 

You can change the default incoming and outgoing topic name as follows:

.Quarkus
[source]
----
kogito.addon.messaging.incoming.defaultName=<default channel name>
kogito.addon.messaging.outgoing.defaultName=<default channel name>
----

Optionally, for Kafka connector, you can define the Kafka topic to be used for that channel using the following form:

`mp.messaging.[incoming|outgoing].<channel name>.topic = <topic name>`

If the topic property is not found, then the topic name is considered to be the same as Kafka name.
Note that you can map different channels to the same topic.

==== Providing a key for a Kafka record

To specify the key to your Kafka record, you can use a custom https://github.com/apache/incubator-kie-kogito-runtimes/blob/main/quarkus/addons/common/reactive-messaging/src/main/java/org/kie/kogito/addon/quarkus/common/reactive/messaging/MessageDecorator.java[MessageDecorator] implementation. 

For an example, see https://github.com/apache/incubator-kie-kogito-examples/blob/main/kogito-quarkus-examples/process-kafka-avro-multi-quarkus/src/main/java/org/acme/travel/StringKeyDecorator.java[StringKeyDecorator.java]

==== Customizing message format

By default, {PRODUCT} uses Cloud event JSON format for messaging. However, you can change the default format by providing your own https://github.com/apache/incubator-kie-kogito-runtimes/blob/main/api/kogito-events-api/src/main/java/org/kie/kogito/event/EventMarshaller.java[event marshaler] implementation. 
For an example, see https://github.com/apache/incubator-kie-kogito-runtimes/blob/main/addons/common/marshallers/avro/src/main/java/org/kie/kogito/event/avro/AvroEventMarshaller.java[AvroEventMarshaller.java example].

=== {PRODUCT} Decision Model and Notation (DMN) event-driven add-on

.Quarkus
To use the DMN event-driven add-on, add the following code to the `pom.xml` file of your project:
[source,xml,subs="attributes+"]
----
<dependency>
  <groupId>org.kie</groupId>
  <artifactId>kie-addons-quarkus-events-decisions</artifactId>
</dependency>
----

////
=== {PRODUCT} explainability add-on

The Explainability add-on in {PRODUCT} provides integration with Explainability and Trusty Services. You can also use https://github.com/apache/incubator-kie-kogito-examples/tree/stable/kogito-quarkus-examples/trusty-demonstration[`trusty-demonstration`] example application.

To use the explainability add-on, add the following code to the `pom.xml` file of your project:

.Quarkus
[source,xml,subs="attributes+"]
----
<dependency>
  <groupId>org.kie.kogito</groupId>
  <artifactId>kogito-addons-quarkus-explainability</artifactId>
</dependency>
----
////

////
=== {PRODUCT} jobs management add-on

The Jobs Management add-on provides integration and configuration for a project using the supporting services related to Jobs. 

To use the Jobs Management add-on, add the following code to the `pom.xml` file of your project:

.Quarkus
[source,xml,subs="attributes+"]
----
<dependency>
  <groupId>org.kie</groupId>
  <artifactId>kogito-addons-quarkus-jobs-management</artifactId>
</dependency>
----
////

=== {PRODUCT} Knative Eventing add-on

The Knative Eventing add-on is used in the {PRODUCT} project for messaging. The https://github.com/apache/incubator-kie-kogito-runtimes/tree/main/addons/common/knative/eventing[{PRODUCT} Knative Eventing] add-on enables your project to connect to a https://knative.dev/docs/developer/eventing/sinks/[sink] or make it a https://github.com/knative-sandbox/eventing-kogito#kogito-source[KogitoSource].

The add-on processes the https://knative.dev/development/developer/eventing/sources/sinkbinding/[`K_SINK`] and https://knative.dev/development/developer/eventing/sources/sinkbinding/reference/#cloudevent-overrides[`K_CE_OVERRIDES`] environment variables injected by Knative Eventing controllers (`SinkBinding` or `KogitoSource`).

The service requires the https://github.com/apache/incubator-kie-kogito-runtimes/tree/main/addons/common/messaging[{PRODUCT} Messaging] and https://quarkus.io/guides/reactive-messaging-http.html[Quarkus HTTP connector] libraries to wire the {PRODUCT} service with a given sink. The {PRODUCT} Messaging and Quarkus HTTP connector perform as dependencies for the Knative Eventing add-on.


To use the Knative Eventing add-on, add the following code to the `pom.xml` file of your project:

.Quarkus
[source,xml,subs="attributes+"]
----
<dependency>
  <groupId>org.kie</groupId>
  <artifactId>kie-addons-quarkus-knative-eventing</artifactId>
</dependency>
----

==== Auto-generated Knative resources

The Knative Eventing add-on can generate Knative Eventing resources by inspecting your BPMN or Serverless Workflow files for event definitions. 

To enable the auto-generation of Knative resources, add the following dependency to your project:

[source,xml,subs="attributes+"]
----
<dependency>
  <groupId>io.quarkus</groupId>
  <artifactId>quarkus-kubernetes</artifactId>
</dependency>
----

After adding the previous dependency, the add-on generates Knative Eventing resources to handle the events that are produced or consumed by your BPMN or Serverless Workflow resources on Knative Eventing platform.

For each consumed event, the add-on generates a https://knative.dev/docs/eventing/broker/triggers/[Knative Eventing Trigger] as shown in the following example:

.Example Knative `Trigger` custom resource for a {PRODUCT} service with `Broker` binding
[source,yaml]
----
apiVersion: eventing.knative.dev/v1
kind: Trigger
metadata:
  name: travellers-trigger-process-knative-quickstart-quarkus
spec:
  broker: default
  filter:
    attributes:
      type: travellers
  subscriber:
    ref:
      apiVersion: serving.knative.dev/v1
      kind: Service
      name: process-knative-quickstart-quarkus
----

The `Trigger` resource requires a subscriber to receive the events that are routed by the `Broker`. In this case, the current {PRODUCT} service work as a subscriber, and the Knative Eventing add-on uses the {PRODUCT} service deployment, which is configured by Quarkus Kubernetes.

If a `Broker` is not specified, the Knative Eventing add-on generates a default `InMemoryChannel` as follows:

.Example `Broker` custom resource for Knative Eventing with default `InMemoryChannel`
[source,yaml]
----
apiVersion: eventing.knative.dev/v1
kind: Broker
metadata:
  name: default
----

If a `Broker` is configured in the target namespace, you can specify the `Broker` using the following property:
`org.kie.kogito.addons.knative.eventing.broker=myKafkaBroker`.

If the {PRODUCT} service contains any produced event definitions, the Knative Eventing add-on generates a https://knative.dev/development/eventing/custom-event-source/sinkbinding/[Knative Eventing `SinkBinding`], or a https://github.com/knative-sandbox/eventing-kogito#kogito-source[Knative Eventing `KogitoSource`]. By default, the `SinkBinding` is generated, but you can change this behavior by setting `org.kie.kogito.addons.knative.eventing.generate-kogito-source` property to `true`.

.Example `SinkBinding` custom resource for Knative Eventing
[source,yaml]
----
apiVersion: sources.knative.dev/v1
kind: SinkBinding
metadata:
  name: sb-process-knative-quickstart-quarkus
spec:
  sink:
    ref:
      apiVersion: eventing.knative.dev/v1
      kind: Broker
      name: default
  subject:
    apiVersion: serving.knative.dev/v1
    kind: Service
    name: process-knative-quickstart-quarkus
----

.Example `KogitoSource` custom resource for Knative Eventing
[source,yaml]
----
apiVersion: kogito.knative.dev/v1alpha1
kind: KogitoSource
metadata:
  name: process-knative-quickstart-quarkus
spec:
  sink:
    ref:
      apiVersion: eventing.knative.dev/v1
      kind: Broker
      name: default
      namespace: ""
  subject:
    apiVersion: serving.knative.dev/v1
    kind: Service
    name: process-knative-quickstart-quarkus
----

The target deployment defined in the Quarkus Kubernetes plugin work as the subject for `SinkBinding` and `KogitoSource`. You can configure the `sink` using the application properties. By default, the generated `Broker` is defined as the `sink`.

The following table lists all the available properties for the Knative Eventing add-on:

.{PRODUCT} Knative Eventing Add-on  properties
[cols="50%,20%,20%", options="header"]
|===
|Property
|Description
|Example value

|`org.kie.kogito.addons.knative.eventing.sink.namespace`
|Property for set sink namespace
|`default`

|`org.kie.kogito.addons.knative.eventing.sink.name`
|Property to set sink name
|`my-sink`

|`org.kie.kogito.addons.knative.eventing.sink.api-version`
|Property to set Kubernetes API version of the sink
|`eventing.knative.dev/v1`

|`org.kie.kogito.addons.knative.eventing.sink.kind`
|Property to set Kubernetes resource kind of the sink
|`Broker`

|`org.kie.kogito.addons.knative.eventing.broker`
|Property to set name of the pre-defined Broker
|`myKafkaBroker`

|`org.kie.kogito.addons.knative.eventing.generate-kogito-source`
|Property to enable the generation of `KogitoSource` instead of `SinkBinding`
|`false`

|`org.kie.kogito.addons.knative.eventing.auto-generate-broker`
|Property to enable the generation of default in-memory Broker
|`true`
|===

For more information about the Knative Eventing add-on, see the following example applications:

* https://github.com/apache/incubator-kie-kogito-examples/tree/main/serverless-workflow-examples/serverless-workflow-order-processing[Serverless Workflow Order Processing]
* https://github.com/apache/incubator-kie-kogito-examples/tree/main/kogito-quarkus-examples/process-knative-quickstart-quarkus[Process Knative Eventing]

=== {PRODUCT} mail add-on

The mail add-on is used to send emails in a process project. To use the mail add-on, add the following code to the `pom.xml` file of your project:

.Quarkus
[source,xml,subs="attributes+"]
----
<dependency>
  <groupId>org.jbpm</groupId>
  <artifactId>jbpm-addons-quarkus-mail</artifactId>
</dependency>
----

=== {PRODUCT} events add-on

The events add-on provides a default implementation in supported target platforms for EventEmitter and EventReceiver interfaces. You can use EventEmitter and EventReceiver interfaces to enable messaging by process, serverless workflow events, and event decision handling. 

==== Implementing message payload decorator
Any dependant add-on can implement the https://github.com/apache/incubator-kie-kogito-runtimes/blob/main/addons/common/messaging/src/main/java/org/kie/kogito/addon/cloudevents/message/MessagePayloadDecorator.java[MessagePayloadDecorator].

.Prerequisites

* You have installed the Events add-on in {PRODUCT}.

.Procedure
. Create a file named `META-INF/services/org.kie.kogito.add-on.cloudevents.message.MessagePayloadDecorator` in your class path.
. Open the file.
. Enter the full name of your implementation class in the file.
. Save the file.

The `MessagePayloadDecoratorProvider` loads the file upon application startup and adds the file to the decoration chain. When {PRODUCT} calls the https://github.com/apache/incubator-kie-kogito-runtimes/blob/main/addons/common/messaging/src/main/java/org/kie/kogito/addon/cloudevents/message/MessagePayloadDecoratorProvider.java[MessagePayloadDecoratorProvider#decorate], your implementation is part of the decoration algorithm.

To use the events add-on, add the following code to the `pom.xml` file of your project:

.Events Process add-on for Quarkus
[source,xml,subs="attributes+"]
----
<dependency>
  <groupId>org.kie</groupId>
  <artifactId>kie-addons-quarkus-events-process</artifactId>
</dependency>
----

.Events decisions add-on for Quarkus
[source,xml,subs="attributes+"]
----
<dependency>
  <groupId>org.kie</groupId>
  <artifactId>kie-addons-events-decisions</artifactId>
</dependency>
----

=== {PRODUCT} monitoring add-on

The monitoring add-on provides monitoring capabilities in the {PRODUCT} project. 

To use the monitoring add-on, add the following code to the `pom.xml` file of your project:

.Quarkus dependency for Elasticsearch
[source,xml,subs="attributes+"]
----
<dependency>
  <groupId>org.kie</groupId>
  <artifactId>kie-addons-quarkus-monitoring-elastic</artifactId>
</dependency>
----

.Quarkus dependency for Prometheus
[source,xml,subs="attributes+"]
----
<dependency>
  <groupId>org.kie</groupId>
  <artifactId>kie-addons-quarkus-monitoring-prometheus</artifactId>
</dependency>
----

////
=== {PRODUCT} persistence add-on

The persistence add-on provides persistence capability in your {PRODUCT} project.

To use the Persistence add-on, add the following code to the `pom.xml` file of your project:

.Quarkus dependency for persistence filesystem
[source,xml,subs="attributes+"]
----
<dependency>
  <groupId>org.kie</groupId>
  <artifactId>kie-addons-quarkus-persistence-filesystem</artifactId>
</dependency>
----

.Quarkus dependency for persistence Infinispan
[source,xml,subs="attributes+"]
----
<dependency>
  <groupId>org.kie</groupId>
  <artifactId>kie-addons-quarkus-persistence-infinispan</artifactId>
</dependency>
----

.Quarkus dependency for persistence JDBC
[source,xml,subs="attributes+"]
----
<dependency>
  <groupId>org.kie</groupId>
  <artifactId>kie-addons-quarkus-persistence-jdbc</artifactId>
</dependency>
----

.Quarkus dependency for persistence MongoDB
[source,xml,subs="attributes+"]
----
<dependency>
  <groupId>org.kie</groupId>
  <artifactId>kie-addons-quarkus-persistence-mongodb</artifactId>
</dependency>
----

.Quarkus dependency for persistence PostgreSQL
[source,xml,subs="attributes+"]
----
<dependency>
  <groupId>org.kie</groupId>
  <artifactId>kie-addons-quarkus-persistence-postgresql</artifactId>
</dependency>
----

.Quarkus dependency for persistence Kafka
[source,xml,subs="attributes+"]
----
<dependency>
  <groupId>org.kie</groupId>
  <artifactId>kie-addons-quarkus-persistence-kafka</artifactId>
</dependency>
----

=== {PRODUCT} process management add-on

[role="_abstract"]
{PRODUCT} provides a `kie-addons-quarkus-process-management` add-on that enables basic REST operations that you can use to manage process instances. These REST operations are supplemental to any other specific REST operations that you have configured in your application.

To configure process management REST capabilities for your {PRODUCT} services, you can add the process management add-on as a dependency in the `pom.xml` file of your {PRODUCT} project:

.Project dependency to enable process management REST operations
[source,xml]
----
<dependency>
  <groupId>org.kie.kogito</groupId>
  <artifactId>kie-addons-quarkus-process-management</artifactId>
</dependency>
----

The {PRODUCT} process management add-on provides REST support for the following basic operations:

* *Process instances*: Abort an active process instance
* *Node instances*:  Cancel or re-trigger a node instance, or trigger a new node instance
* *Error handling*: Retrieve error details for a process instance, or skip or re-trigger a failed node instance

In addition to exposed REST operations, the process management add-on also provides the following REST exception mappers to generate more meaningful error messages for typical exception types:

* `ProcessInstanceNotFound`
* `NodeInstanceNotFound`
* `NodeNotFound`
* `ProcessInstanceExecutionError`
* `NotAuthorized`
* `InvalidTransition` (for work items)
* `InvalidLifeCyclePhase` (for work items)

These exception mappers produce a valid HTTP error code with JSON payload with the context that caused the exception.

For example, the following is a `ProcessInstanceNotFoundException` error generated at runtime:

.Example error with JSON payload at runtime
[source,json]
----
HTTP code : 404

{
  "processInstanceId" : "c6862071-0f2e-4f21-9bc8-586245a76c3aa",
  "message" : "Process instance with id c6862071-0f2e-4f21-9bc8-586245a76c3aa not found"
}
----
////

////
=== {PRODUCT} process SVG add-on

[role="_abstract"]
{PRODUCT} provides an add-on named `process-svg-addon`, enabling the basic REST operations that you can use to visualize the process diagram and execution path of the related process instances. The REST operations are supplemental to any other specific REST operation that is configured in your application.

The add-on requires the access of process SVG files. The process SVG files can be placed in a file system, which is accessible to the service or available in `META-INF/processSVG/` folder in the class path. For example, when the SVG files are generated, rename the files to `\{processId\}.svg`. The `\{processId\}.svg` file is used by the add-on and placed in a file system folder (accessible by the service) or in `META-INF/processSVG` folder in the class path. The configuration property `kogito.svg.folder.path` of the add-on points to the file system folder, otherwise the files are searched in the class path.

The VS Code extension enables you to export the process to SVG format:

.Export process diagram at VS Code
image::kogito/bpmn/kogito-svg-addon-manually-export.png[Manually export to SVG at VS Code]

[NOTE]
====
When you export a process to SVG format, the generated SVG is named to \{processFileName\}-svg.svg.
====

The process code generation searches this export and, if this file exists, copies and renames it to `META-INF/processSVG/\{processId\}.svg allowing the process SVG addon to consume it directly.

To configure process SVG REST capabilities for your {PRODUCT} services, you can add the process SVG add-on as a dependency in the `pom.xml` file of your {PRODUCT} project:

.Project dependency to enable process SVG REST operations in Quarkus projects
[source,xml]
----
<dependency>
  <groupId>org.kie</groupId>
  <artifactId>kie-addons-quarkus-process-svg</artifactId>
</dependency>
----

The process SVG add-on provides the following set of configuration properties:

.Process SVG add-on configuration properties in {PRODUCT}
[cols="30%,70%"]
|===
|Property
|Description

|`kogito.svg.folder.path`
|Determines the folder in which the add-on searches the initial process diagrams. If this property is not enabled, then the add-on searches `META-INF/processSVG/` folder in the class path.

Default value: `empty`

Example: `kogito.svg.folder.path=/home/user/diagrams`

a|`kogito.svg.color.completed`
|Changes the color to fill the completed nodes when showing the execution path.

Default value: `#C0C0C0`

Example: `kogito.svg.color.completed=#C2C0C1`

a|`kogito.svg.color.completed.border`
|Changes the color of the border of the completed node when showing the execution path.

Default value: `#030303`

Example: `kogito.svg.color.completed.border=#C2C0C1`

a|`kogito.svg.color.active.border`
|Changes the color of the border of the active node when showing the execution path.

Default value: `#FF0000`

Example: `kogito.svg.color.active.border=#C2C0C1`

|===

The {PRODUCT} process SVG add-on provides REST support for the following basic operations:

* *Process Diagram*: Return the process SVG diagram
* *Process instance diagram*: Return the process SVG diagram displaying the executed path of a specific process instance
////

=== {PRODUCT} process event add-on

{PRODUCT} provides a process event add-on, which you can use to send processes, tasks, and variable events to an external event listener. In this case, the processes, tasks, and variable events are generated as a result of the execution of an operation, which modifies a process state; such events are known as runtime events.

In {PRODUCT}, every modifying operation is executed within an abstraction called a unit of work. Examples of such operations include creating a process instance, transitioning a task, and modifying a variable. A runtime event is published when a unit of work is completed.

You can use the {PRODUCT} process event add-on to build a historical representation of all process instance executions. Also, you can use this add-on with process REST API to build a custom graphical user interface to handle the user tasks.

By default, the event format follows the https://cloudevents.io/[CloudEvent] specification, sending information using the data field.
The data field contains a JSON of one of the following types:

* https://github.com/apache/incubator-kie-kogito-runtimes/blob/main/api/kogito-events-api/src/main/java/org/kie/kogito/event/process/ProcessInstanceEventMetadata.java[ProcessInstanceEvent]: This event is published when a process instance is created, modified, or completed.
// * https://github.com/apache/incubator-kie-kogito-runtimes/blob/main/api/kogito-events-api/src/main/java/org/kie/kogito/event/usertask/UserTaskInstanceEventMetadata.java[UserTaskInstanceEvent]: This event is published when a change occurs on a user task.
* https://github.com/apache/incubator-kie-kogito-runtimes/blob/main/api/kogito-events-api/src/main/java/org/kie/kogito/event/process/ProcessInstanceVariableEventBody.java[VariableInstanceEvent]: This event is published when a variable is created, modified, or removed.

To configure process event capabilities for your {PRODUCT} services, you can add the process event add-on as a dependency in the `pom.xml` file of your {PRODUCT} project:

.Project dependency to enable process event operations in Quarkus projects
[source,xml,subs="attributes+"]
----
<dependency>
  <groupId>org.kie</groupId>
  <artifactId>kie-addons-quarkus-events-process</artifactId>
</dependency>
----

For Quarkus, the {PRODUCT} process event add-on implementation is based on https://smallrye.io/smallrye-reactive-messaging/smallrye-reactive-messaging/2/connectors/connectors.html[Smallrye Messaging] library, which provides a set of connectors for event brokers, such as JMS, AMQP, and Kafka. Therefore, the {PRODUCT} process event add-on is not specifically combined with any event broker in Quarkus, but requires additional configuration to use a suitable Smallrye connector.

For example, to use Kafka as an event broker in Quarkus, you can add the following dependency in the `pom.xml` file of your {PRODUCT} project:

.Project dependency to enable Kafka event broker in Quarkus
[source,xml,subs="attributes+"]
----
 <dependency>
  <groupId>io.quarkus</groupId>
  <artifactId>quarkus-smallrye-reactive-messaging-kafka</artifactId>
</dependency>
----

Smallrye defines an abstraction named channel to enable multi-broker support. For every channel that you define in your {PRODUCT} application, you can specify the connector to use for that channel using the following form:

`mp.messaging.[incoming|outgoing].<channel name>.connector = <connector name>`

Optionally, for Kafka connector, you can define the Kafka topic to be used for that channel using the following form:

`mp.messaging.[incoming|outgoing].<channel name>.topic = <topic name>`

You can also set up a channel property using the following form:

`mp.messaging.[incoming|outgoing].<channel name>.<property name>= <property value>`

IMPORTANT: If the defined property is not found, then the topic name is considered to be the same as Kafka name.

The {PRODUCT} process event add-on defines a channel for each event type, such as `kogito-processinstances-events`, `kogito-usertaskinstances-events`, and `kogito-variables-events`. Therefore, when the process event add-on is enabled, you must add the event types to your `application.properties` file using the following properties:

.Properties to define event types in `application.properties` file
[source]
----
mp.messaging.outgoing.kogito-processinstances-events.connector=smallrye-kafka
mp.messaging.outgoing.kogito-processinstances-events.topic=kogito-processinstances-events
mp.messaging.outgoing.kogito-processinstances-events.value.serializer=org.apache.kafka.common.serialization.StringSerializer

mp.messaging.outgoing.kogito-usertaskinstances-events.connector=smallrye-kafka
mp.messaging.outgoing.kogito-usertaskinstances-events.topic=kogito-usertaskinstances-events
mp.messaging.outgoing.kogito-usertaskinstances-events.value.serializer=org.apache.kafka.common.serialization.StringSerializer

mp.messaging.outgoing.kogito-variables-events.connector=smallrye-kafka
mp.messaging.outgoing.kogito-variables-events.topic=kogito-variables-events
mp.messaging.outgoing.kogito-variables-events.value.serializer=org.apache.kafka.common.serialization.StringSerializer
----

Additionally, you can disable the publishing on any channel by setting the related property to false as shown in the following example:

.Example properties to disable publishing
[source]
----
kogito.events.usertasks.enabled=false
kogito.events.variables.enabled=false
----


=== {PRODUCT} tracing add-on

The Tracing add-on provides Decision model and notation (DMN) services tracing capability.

To use the Tracing add-on, add the following code to the `pom.xml` file of your project:

.Quarkus
[source,xml,subs="attributes+"]
----
<dependency>
  <groupId>org.kie</groupId>
  <artifactId>kie-addons-quarkus-tracing-decision</artifactId>
</dependency>
----

[#source-files-add-on]
=== {PRODUCT} source files add-on

The {PRODUCT} Source Files Add-on adds the capability of listing and downloading source files to {PRODUCT} projects.

> **⚠️**
This add-on isn't supposed to be used by end-users, if not needed for internal integrations, since it can be a potential security breach for some users' use cases.

To add the endpoints to download your services' source files, you can add the source files add-on as a dependency in your `pom.xml` file.

.Project dependency to enable source files endpoints
[source,xml]
----
<dependency>
  <groupId>org.kie</groupId>
  <artifactId>kie-addons-quarkus-source-files</artifactId>
</dependency>
----

Access to all the endpoints is granted to the role `source-files-client`.
To define basic authentication, you can add the following code to your `application.properties` file:

.Example of credentials for the user `scott` and password `jb0ss`
[source,properties]
----
quarkus.security.users.embedded.enabled=true
quarkus.security.users.embedded.plain-text=true
quarkus.security.users.embedded.users.scott=jb0ss
quarkus.security.users.embedded.roles.scott=source-files-client
----

You can also disable plain-text passwords by setting the `quarkus.security.users.embedded.plain-text` property to
`false` or just removing it from the configuration. In this case, the passwords are encrypted using MD5.

.Example of credentials for the user `scott` and password `jb0ss` encrypted using MD5
[source,properties]
----
quarkus.security.users.embedded.enabled=true
quarkus.security.users.embedded.users.scott=4960d03c13b5aff4ca6886758a8be019
quarkus.security.users.embedded.roles.scott=source-files-client
----

To define a more robust authentication mechanism, you can refer to the https://quarkus.io/guides/security[Quarkus documentation].

The Source Files Add-on provides REST support for the following operation:

==== List all the source files for the specified process

* GET: `/management/processes/\{processId\}/sources`
** parameters:
*** processId: process identifier
** output:
*** JSON with related source files URIs

.Example: to list the source files for the process with id `petstore_http`, you can use the following command:

[source,bash]
----
$ curl -X 'GET' \
  'http://localhost:8080/management/processes/petstore_http/sources' \
  -H 'accept: application/json' \
  -H 'Authorization: Basic c2NvdHQ6amIwc3M='
----

.Output

[source,json]
----
[
  {
    "uri": "https://raw.githubusercontent.com/OAI/OpenAPI-Specification/main/examples/v2.0/json/petstore-simple.json"
  },
  {
    "uri": "/sources/org/kie/kogito/examples/petstore_http.sw.json"
  }
]
----

==== Download the specified source file

* GET: `/management/processes/\{processId\}/source`
** parameters:
*** processId: process identifier
** output:
*** Source file content used by the editor

.Example: to list the source file for the process with id `petstore_http`, you can use the following command:

[source,bash]
----
$ curl -X 'GET' \
  'http://localhost:8080/management/processes/petstore_http/source' \
  -H 'accept: application/json' \
  -H 'Authorization: Basic c2NvdHQ6amIwc3M='
----

.Output

[source,json]
----
{
  "id": "petstore_http",
  "version": "1.0",
  "name": "Send CloudEvent after creating Pluto",
  "start": "AddPluto",
  "functions": [
    {
      "name": "addPet",
      "operation": "https://raw.githubusercontent.com/OAI/OpenAPI-Specification/main/examples/v2.0/json/petstore-simple.json#addPet"
    }
  ],
  "states": [
    {
      "name": "AddPluto",
      "type": "operation",
      "actions": [
        {
          "functionRef": {
            "refName": "addPet",
            "parameters": {
              "body": {
                "name": "Pluto"
              }
            }
          }
        }
      ],
      "end": true
    }
  ]
}
----
.Example: to download the source file located at `org/kie/kogito/examples/petstore_http.sw.json`, you can use the following command:

[source,bash]
----
$ curl -X 'GET' \
  'http://localhost:8080/sources?uri=org/kie/kogito/examples/petstore_http.sw.json' \
  -H 'accept: */*' \
  -H 'Authorization: Basic c2NvdHQ6amIwc3M='
----

[id="proc-kogito-designing-app"]
== Designing the application logic for a {PRODUCT} service using BPMN and DMN

[role="_abstract"]
After you create your {PRODUCT} project, you can create or import Business Process Model and Notation (BPMN) business processes, Decision Model and Notation (DMN) decision models, Drools Rule Language (DRL) business rules, spreadsheet Decision Tables, and other assets in the `src/main/resources` folder of your project. You can also include Java classes in the `src/main/java` folder of your project that act as Java services or provide implementations that you call from your business processes or decisions.

The example for this procedure is a basic {PRODUCT} service that provides a REST endpoint `/persons`. This endpoint is automatically generated based on an example `PersonProcess.bpmn2` business process that employs an example `PersonDecisions.dmn` DMN model to make decisions based on the data being processed.

The business process contains the business logic of the {PRODUCT} service. The process provides the complete set of steps to achieve the business goal. The process is also the entry point to the service that can be consumed by other services.

The business decision contains the decision logic of the {PRODUCT} service. In this example, the decision logic is invoked as part of the business process. You can define business rules and decisions in several ways, such as with DMN models, DRL rules, or spreadsheet Decision Tables. The example for this procedure uses a DMN model.

.Procedure
. In the Maven project that you generated for your {PRODUCT} service, navigate to the `src/main/java/org/acme` folder and add the following `Person.java` file:
+
--
.Example person Java object
[source,java]
----
package org.acme;

import java.io.Serializable;

public class Person {

	private String name;
	private int age;
	private boolean adult;

	public String getName() {
		return name;
	}

	public void setName(String name) {
		this.name = name;
	}

	public int getAge() {
		return age;
	}

	public void setAge(int age) {
		this.age = age;
	}

	public boolean isAdult() {
		return adult;
	}

	public void setAdult(boolean adult) {
		this.adult = adult;
	}

	@Override
	public String toString() {
		return "Person [name=" + name + ", age=" + age + ", adult=" + adult + "]";
	}

}
----
This example Java object sets and retrieves a person's name, age, and adult status.
--
. Navigate to the `src/main/resources` folder and add the following `PersonDecisions.dmn` DMN decision model:
+
--
.Example `PersonDecisions` DMN decision requirements diagram (DRD)
image::kogito-dmn-example-person.png[Image of PersonDecisions decision diagram]

.Example DMN boxed expression for `isAdult` decision
image::kogito-dmn-example-person-logic.png[Image of PersonDecisions Decision Table]

.Example DMN data types
image::kogito-dmn-example-person-data-types.png[Image of PersonDecisions data types]

This example DMN model consists of a basic DMN input node and a decision node defined by a DMN Decision Table with a custom structured data type.

In VS Code, you can add the {DEV_TOOLS_VSCODE_MARKETPLACE_LINK}[*{DEV_TOOLS}*] to design the decision requirements diagram (DRD), boxed expression, and data types with the {PRODUCT} DMN Editor.

To create this example DMN model quickly, you can copy the following `PersonDecisions.dmn` file content:

.Example DMN file
[source,xml]
----
<dmn:definitions xmlns:dmn="http://www.omg.org/spec/DMN/20180521/MODEL/" xmlns="https://kiegroup.org/dmn/_52CEF9FD-9943-4A89-96D5-6F66810CA4C1" xmlns:di="http://www.omg.org/spec/DMN/20180521/DI/" xmlns:kie="http://www.drools.org/kie/dmn/1.2" xmlns:dmndi="http://www.omg.org/spec/DMN/20180521/DMNDI/" xmlns:dc="http://www.omg.org/spec/DMN/20180521/DC/" xmlns:feel="http://www.omg.org/spec/DMN/20180521/FEEL/" id="_84B432F5-87E7-43B1-9101-1BAFE3D18FC5" name="PersonDecisions" typeLanguage="http://www.omg.org/spec/DMN/20180521/FEEL/" namespace="https://kiegroup.org/dmn/_52CEF9FD-9943-4A89-96D5-6F66810CA4C1">
  <dmn:extensionElements/>
  <dmn:itemDefinition id="_DEF2C3A7-F3A9-4ABA-8D0A-C823E4EB43AB" name="tPerson" isCollection="false">
    <dmn:itemComponent id="_DB46DB27-0752-433F-ABE3-FC9E3BDECC97" name="Age" isCollection="false">
      <dmn:typeRef>number</dmn:typeRef>
    </dmn:itemComponent>
    <dmn:itemComponent id="_8C6D865F-E9C8-43B0-AB4D-3F2075A4ECA6" name="Name" isCollection="false">
      <dmn:typeRef>string</dmn:typeRef>
    </dmn:itemComponent>
    <dmn:itemComponent id="_9033704B-4E1C-42D3-AC5E-0D94107303A1" name="Adult" isCollection="false">
      <dmn:typeRef>boolean</dmn:typeRef>
    </dmn:itemComponent>
  </dmn:itemDefinition>
  <dmn:inputData id="_F9685B74-0C69-4982-B3B6-B04A14D79EDB" name="Person">
    <dmn:extensionElements/>
    <dmn:variable id="_0E345A3C-BB1F-4FB2-B00F-C5691FD1D36C" name="Person" typeRef="tPerson"/>
  </dmn:inputData>
  <dmn:decision id="_0D2BD7A9-ACA1-49BE-97AD-19699E0C9852" name="isAdult">
    <dmn:extensionElements/>
    <dmn:variable id="_54CD509F-452F-40E5-941C-AFB2667D4D45" name="isAdult" typeRef="boolean"/>
    <dmn:informationRequirement id="_2F819B03-36B7-4DEB-AED6-2B46AE3ADB75">
      <dmn:requiredInput href="#_F9685B74-0C69-4982-B3B6-B04A14D79EDB"/>
    </dmn:informationRequirement>
    <dmn:decisionTable id="_58370567-05DE-4EC0-AC2D-A23803C1EAAE" hitPolicy="UNIQUE" preferredOrientation="Rule-as-Row">
      <dmn:input id="_ADEF36CD-286A-454A-ABD8-9CF96014021B">
        <dmn:inputExpression id="_4930C2E5-7401-46DD-8329-EAC523BFA492" typeRef="number">
          <dmn:text>Person.Age</dmn:text>
        </dmn:inputExpression>
      </dmn:input>
      <dmn:output id="_9867E9A3-CBF6-4D66-9804-D2206F6B4F86" typeRef="boolean"/>
      <dmn:rule id="_59D6BFF0-35B4-4B7E-8D7B-E31CB0DB8242">
        <dmn:inputEntry id="_7DC55D63-234F-497B-A12A-93DA358C0136">
          <dmn:text>&gt; 18</dmn:text>
        </dmn:inputEntry>
        <dmn:outputEntry id="_B3BB5B97-05B9-464A-AB39-58A33A9C7C00">
          <dmn:text>true</dmn:text>
        </dmn:outputEntry>
      </dmn:rule>
      <dmn:rule id="_8FCD63FE-8AD8-4F56-AD12-923E87AFD1B1">
        <dmn:inputEntry id="_B4EF7F13-E486-46CB-B14E-1D21647258D9">
          <dmn:text>&lt;= 18</dmn:text>
        </dmn:inputEntry>
        <dmn:outputEntry id="_F3A9EC8E-A96B-42A0-BF87-9FB1F2FDB15A">
          <dmn:text>false</dmn:text>
        </dmn:outputEntry>
      </dmn:rule>
    </dmn:decisionTable>
  </dmn:decision>
  <dmndi:DMNDI>
    <dmndi:DMNDiagram>
      <di:extension>
        <kie:ComponentsWidthsExtension>
          <kie:ComponentWidths dmnElementRef="_58370567-05DE-4EC0-AC2D-A23803C1EAAE">
            <kie:width>50</kie:width>
            <kie:width>100</kie:width>
            <kie:width>100</kie:width>
            <kie:width>100</kie:width>
          </kie:ComponentWidths>
        </kie:ComponentsWidthsExtension>
      </di:extension>
      <dmndi:DMNShape id="dmnshape-_F9685B74-0C69-4982-B3B6-B04A14D79EDB" dmnElementRef="_F9685B74-0C69-4982-B3B6-B04A14D79EDB" isCollapsed="false">
        <dmndi:DMNStyle>
          <dmndi:FillColor red="255" green="255" blue="255"/>
          <dmndi:StrokeColor red="0" green="0" blue="0"/>
          <dmndi:FontColor red="0" green="0" blue="0"/>
        </dmndi:DMNStyle>
        <dc:Bounds x="404" y="464" width="100" height="50"/>
        <dmndi:DMNLabel/>
      </dmndi:DMNShape>
      <dmndi:DMNShape id="dmnshape-_0D2BD7A9-ACA1-49BE-97AD-19699E0C9852" dmnElementRef="_0D2BD7A9-ACA1-49BE-97AD-19699E0C9852" isCollapsed="false">
        <dmndi:DMNStyle>
          <dmndi:FillColor red="255" green="255" blue="255"/>
          <dmndi:StrokeColor red="0" green="0" blue="0"/>
          <dmndi:FontColor red="0" green="0" blue="0"/>
        </dmndi:DMNStyle>
        <dc:Bounds x="404" y="311" width="100" height="50"/>
        <dmndi:DMNLabel/>
      </dmndi:DMNShape>
      <dmndi:DMNEdge id="dmnedge-_2F819B03-36B7-4DEB-AED6-2B46AE3ADB75" dmnElementRef="_2F819B03-36B7-4DEB-AED6-2B46AE3ADB75">
        <di:waypoint x="504" y="489"/>
        <di:waypoint x="404" y="336"/>
      </dmndi:DMNEdge>
    </dmndi:DMNDiagram>
  </dmndi:DMNDI>
</dmn:definitions>
----

To create this example DMN model in VS Code using the {PRODUCT} DMN Editor, follow these steps:

.. Open the empty `PersonDecisions.dmn` file and in the upper-right corner of the DMN Editor, click the *Properties* icon and confirm that the DMN model *Name* is set to `PersonDecisions`.
.. In the left palette, select *DMN Input Data*, drag the node to the diagram, and double-click the node to name it `Person`.
.. In the left palette, select *DMN Decision*, drag the node to the diagram, double-click the node to name it `isAdult`, and link to it from the input node.
.. Select the decision node to display the node options and click the *Edit* icon to open the DMN boxed expression editor to define the decision logic for the node.
.. Click the undefined expression field and select *Decision Table*.
.. Click the upper-left corner of the Decision Table to set the hit policy to *Unique*.
.. Set the input and output columns so that the input source `Person.Age` with type `number` determines the age limit and the output target `isAdult` with type `boolean` determines adult status:
+
.Example DMN Decision Table for `isAdult` Decision
image::kogito-dmn-example-person-logic.png[Image of PersonDecisions Decision Table]
.. In the upper tab options, select the *Data Types* tab and add the following `tPerson` structured data type and nested data types:
+
.Example DMN data types
image::kogito-dmn-example-person-data-types.png[Image of PersonDecisions data types]
.. After you define the data types, select the *Editor* tab to return to the DMN Editor diagram.
.. Select the *Person* input node, click the *Properties* icon, and under *Information item*, set the *Data type* to `tPerson`.
.. Select the *isAdult* decision node, click the *Properties* icon, and under *Information item*, confirm that the *Data type* is still set to `boolean`. You previously set this data type when you created the Decision Table.
.. Save the DMN Decision file.
--
. In the `src/main/resources` folder, add the following `PersonProcess.bpmn2` BPMN process model:
+
--
.Example `PersonProcess` BPMN process
image::kogito-bpmn-example-person.png[Image of person process diagram]

This example process consists of the following basic BPMN components:

* Start event
* Business Rule Task
* Exclusive gateway
* User Task
* End event

In VS Code, you can add the {DEV_TOOLS_VSCODE_MARKETPLACE_LINK}[*{DEV_TOOLS}*] to model the business process with the {PRODUCT_SHORT} BPMN Editor.

To create this example process quickly, you can copy the following `PersonProcess.bpmn2` file content:

.Example BPMN file
[source,xml]
----
<bpmn2:definitions xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:bpmn2="http://www.omg.org/spec/BPMN/20100524/MODEL" xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI" xmlns:bpsim="http://www.bpsim.org/schemas/1.0" xmlns:dc="http://www.omg.org/spec/DD/20100524/DC" xmlns:di="http://www.omg.org/spec/DD/20100524/DI" xmlns:drools="http://www.jboss.org/drools" id="_J4ElsVJgEDiScotxwBQ14Q" exporter="jBPM Process Modeler" exporterVersion="2.0" targetNamespace="http://www.omg.org/bpmn20">
  <bpmn2:itemDefinition id="_personItem" structureRef="org.acme.Person"/>
  <bpmn2:itemDefinition id="_isAdultItem" structureRef="Boolean"/>
  <bpmn2:itemDefinition id="_UserTask_1_SkippableInputXItem" structureRef="Object"/>
  <bpmn2:itemDefinition id="_UserTask_1_PriorityInputXItem" structureRef="Object"/>
  <bpmn2:itemDefinition id="_UserTask_1_CommentInputXItem" structureRef="Object"/>
  <bpmn2:itemDefinition id="_UserTask_1_DescriptionInputXItem" structureRef="Object"/>
  <bpmn2:itemDefinition id="_UserTask_1_CreatedByInputXItem" structureRef="Object"/>
  <bpmn2:itemDefinition id="_UserTask_1_TaskNameInputXItem" structureRef="Object"/>
  <bpmn2:itemDefinition id="_UserTask_1_GroupIdInputXItem" structureRef="Object"/>
  <bpmn2:itemDefinition id="_UserTask_1_ContentInputXItem" structureRef="Object"/>
  <bpmn2:itemDefinition id="_UserTask_1_NotStartedReassignInputXItem" structureRef="Object"/>
  <bpmn2:itemDefinition id="_UserTask_1_NotCompletedReassignInputXItem" structureRef="Object"/>
  <bpmn2:itemDefinition id="_UserTask_1_NotStartedNotifyInputXItem" structureRef="Object"/>
  <bpmn2:itemDefinition id="_UserTask_1_NotCompletedNotifyInputXItem" structureRef="Object"/>
  <bpmn2:itemDefinition id="_UserTask_1_personInputXItem" structureRef="org.acme.Person"/>
  <bpmn2:itemDefinition id="_BusinessRuleTask_1_namespaceInputXItem" structureRef="java.lang.String"/>
  <bpmn2:itemDefinition id="_BusinessRuleTask_1_modelInputXItem" structureRef="java.lang.String"/>
  <bpmn2:itemDefinition id="_BusinessRuleTask_1_decisionInputXItem" structureRef="java.lang.String"/>
  <bpmn2:itemDefinition id="_BusinessRuleTask_1_PersonInputXItem" structureRef="org.acme.Person"/>
  <bpmn2:itemDefinition id="_BusinessRuleTask_1_isAdultOutputXItem" structureRef="Boolean"/>
  <bpmn2:process id="persons" drools:packageName="org.acme" drools:version="1.0" drools:adHoc="false" name="Person Process" isExecutable="true" processType="Public">
    <bpmn2:property id="person" itemSubjectRef="_personItem" name="person"/>
    <bpmn2:property id="isAdult" itemSubjectRef="_isAdultItem" name="isAdult"/>
    <bpmn2:sequenceFlow id="SequenceFlow_1" sourceRef="StartEvent_1" targetRef="BusinessRuleTask_1"/>
    <bpmn2:sequenceFlow id="SequenceFlow_2" sourceRef="BusinessRuleTask_1" targetRef="ExclusiveGateway_1"/>
    <bpmn2:sequenceFlow id="SequenceFlow_3" sourceRef="ExclusiveGateway_1" targetRef="UserTask_1">
      <bpmn2:conditionExpression xsi:type="bpmn2:tFormalExpression" language="http://www.java.com/java">return isAdult == false;</bpmn2:conditionExpression>
    </bpmn2:sequenceFlow>
    <bpmn2:sequenceFlow id="SequenceFlow_4" sourceRef="UserTask_1" targetRef="EndEvent_1"/>
    <bpmn2:sequenceFlow id="SequenceFlow_5" sourceRef="ExclusiveGateway_1" targetRef="EndEvent_2">
      <bpmn2:conditionExpression xsi:type="bpmn2:tFormalExpression" language="http://www.java.com/java">return isAdult == true;</bpmn2:conditionExpression>
    </bpmn2:sequenceFlow>
    <bpmn2:startEvent id="StartEvent_1" name="StartProcess">
      <bpmn2:extensionElements>
        <drools:metaData name="elementname">
          <drools:metaValue>StartProcess</drools:metaValue>
        </drools:metaData>
      </bpmn2:extensionElements>
      <bpmn2:outgoing>SequenceFlow_1</bpmn2:outgoing>
    </bpmn2:startEvent>
    <bpmn2:businessRuleTask id="BusinessRuleTask_1" name="Evaluate person" implementation="http://www.jboss.org/drools/dmn">
      <bpmn2:extensionElements>
        <drools:metaData name="elementname">
          <drools:metaValue>Evaluate person</drools:metaValue>
        </drools:metaData>
      </bpmn2:extensionElements>
      <bpmn2:incoming>SequenceFlow_1</bpmn2:incoming>
      <bpmn2:outgoing>SequenceFlow_2</bpmn2:outgoing>
      <bpmn2:ioSpecification>
        <bpmn2:dataInput id="BusinessRuleTask_1_namespaceInputX" drools:dtype="java.lang.String" itemSubjectRef="_BusinessRuleTask_1_namespaceInputXItem" name="namespace"/>
        <bpmn2:dataInput id="BusinessRuleTask_1_decisionInputX" drools:dtype="java.lang.String" itemSubjectRef="_BusinessRuleTask_1_decisionInputXItem" name="decision"/>
        <bpmn2:dataInput id="BusinessRuleTask_1_modelInputX" drools:dtype="java.lang.String" itemSubjectRef="_BusinessRuleTask_1_modelInputXItem" name="model"/>
        <bpmn2:dataInput id="BusinessRuleTask_1_PersonInputX" drools:dtype="org.acme.Person" itemSubjectRef="_BusinessRuleTask_1_PersonInputXItem" name="Person"/>
        <bpmn2:dataOutput id="BusinessRuleTask_1_isAdultOutputX" drools:dtype="Boolean" itemSubjectRef="_BusinessRuleTask_1_isAdultOutputXItem" name="isAdult"/>
        <bpmn2:inputSet>
          <bpmn2:dataInputRefs>BusinessRuleTask_1_namespaceInputX</bpmn2:dataInputRefs>
          <bpmn2:dataInputRefs>BusinessRuleTask_1_decisionInputX</bpmn2:dataInputRefs>
          <bpmn2:dataInputRefs>BusinessRuleTask_1_modelInputX</bpmn2:dataInputRefs>
          <bpmn2:dataInputRefs>BusinessRuleTask_1_PersonInputX</bpmn2:dataInputRefs>
        </bpmn2:inputSet>
        <bpmn2:outputSet>
          <bpmn2:dataOutputRefs>BusinessRuleTask_1_isAdultOutputX</bpmn2:dataOutputRefs>
        </bpmn2:outputSet>
      </bpmn2:ioSpecification>
      <bpmn2:dataInputAssociation>
        <bpmn2:targetRef>BusinessRuleTask_1_namespaceInputX</bpmn2:targetRef>
        <bpmn2:assignment>
          <bpmn2:from xsi:type="bpmn2:tFormalExpression">https://kiegroup.org/dmn/_52CEF9FD-9943-4A89-96D5-6F66810CA4C1</bpmn2:from>
          <bpmn2:to xsi:type="bpmn2:tFormalExpression">BusinessRuleTask_1_namespaceInputX</bpmn2:to>
        </bpmn2:assignment>
      </bpmn2:dataInputAssociation>
      <bpmn2:dataInputAssociation>
        <bpmn2:targetRef>BusinessRuleTask_1_decisionInputX</bpmn2:targetRef>
        <bpmn2:assignment>
          <bpmn2:from xsi:type="bpmn2:tFormalExpression">isAdult</bpmn2:from>
          <bpmn2:to xsi:type="bpmn2:tFormalExpression">BusinessRuleTask_1_decisionInputX</bpmn2:to>
        </bpmn2:assignment>
      </bpmn2:dataInputAssociation>
      <bpmn2:dataInputAssociation>
        <bpmn2:targetRef>BusinessRuleTask_1_modelInputX</bpmn2:targetRef>
        <bpmn2:assignment>
          <bpmn2:from xsi:type="bpmn2:tFormalExpression">PersonDecisions</bpmn2:from>
          <bpmn2:to xsi:type="bpmn2:tFormalExpression">BusinessRuleTask_1_modelInputX</bpmn2:to>
        </bpmn2:assignment>
      </bpmn2:dataInputAssociation>
      <bpmn2:dataInputAssociation>
        <bpmn2:sourceRef>person</bpmn2:sourceRef>
        <bpmn2:targetRef>BusinessRuleTask_1_PersonInputX</bpmn2:targetRef>
      </bpmn2:dataInputAssociation>
      <bpmn2:dataOutputAssociation>
        <bpmn2:sourceRef>BusinessRuleTask_1_isAdultOutputX</bpmn2:sourceRef>
        <bpmn2:targetRef>isAdult</bpmn2:targetRef>
      </bpmn2:dataOutputAssociation>
    </bpmn2:businessRuleTask>
    <bpmn2:exclusiveGateway id="ExclusiveGateway_1" name="Exclusive Gateway 1" gatewayDirection="Diverging">
      <bpmn2:extensionElements>
        <drools:metaData name="elementname">
          <drools:metaValue>Exclusive Gateway 1</drools:metaValue>
        </drools:metaData>
      </bpmn2:extensionElements>
      <bpmn2:incoming>SequenceFlow_2</bpmn2:incoming>
      <bpmn2:outgoing>SequenceFlow_5</bpmn2:outgoing>
      <bpmn2:outgoing>SequenceFlow_3</bpmn2:outgoing>
    </bpmn2:exclusiveGateway>
    <bpmn2:userTask id="UserTask_1" name="Special handling for children">
      <bpmn2:extensionElements>
        <drools:metaData name="elementname">
          <drools:metaValue>Special handling for children</drools:metaValue>
        </drools:metaData>
      </bpmn2:extensionElements>
      <bpmn2:incoming>SequenceFlow_3</bpmn2:incoming>
      <bpmn2:outgoing>SequenceFlow_4</bpmn2:outgoing>
      <bpmn2:ioSpecification>
        <bpmn2:dataInput id="UserTask_1_TaskNameInputX" drools:dtype="Object" itemSubjectRef="_UserTask_1_TaskNameInputXItem" name="TaskName"/>
        <bpmn2:dataInput id="UserTask_1_personInputX" drools:dtype="org.acme.Person" itemSubjectRef="_UserTask_1_personInputXItem" name="person"/>
        <bpmn2:dataInput id="UserTask_1_SkippableInputX" drools:dtype="Object" itemSubjectRef="_UserTask_1_SkippableInputXItem" name="Skippable"/>
        <bpmn2:dataInput id="UserTask_1_PriorityInputX" drools:dtype="Object" itemSubjectRef="_UserTask_1_PriorityInputXItem" name="Priority"/>
        <bpmn2:inputSet>
          <bpmn2:dataInputRefs>UserTask_1_TaskNameInputX</bpmn2:dataInputRefs>
          <bpmn2:dataInputRefs>UserTask_1_personInputX</bpmn2:dataInputRefs>
          <bpmn2:dataInputRefs>UserTask_1_SkippableInputX</bpmn2:dataInputRefs>
          <bpmn2:dataInputRefs>UserTask_1_PriorityInputX</bpmn2:dataInputRefs>
        </bpmn2:inputSet>
      </bpmn2:ioSpecification>
      <bpmn2:dataInputAssociation>
        <bpmn2:targetRef>UserTask_1_TaskNameInputX</bpmn2:targetRef>
        <bpmn2:assignment>
          <bpmn2:from xsi:type="bpmn2:tFormalExpression">ChildrenHandling</bpmn2:from>
          <bpmn2:to xsi:type="bpmn2:tFormalExpression">UserTask_1_TaskNameInputX</bpmn2:to>
        </bpmn2:assignment>
      </bpmn2:dataInputAssociation>
      <bpmn2:dataInputAssociation>
        <bpmn2:sourceRef>person</bpmn2:sourceRef>
        <bpmn2:targetRef>UserTask_1_personInputX</bpmn2:targetRef>
      </bpmn2:dataInputAssociation>
      <bpmn2:dataInputAssociation>
        <bpmn2:targetRef>UserTask_1_SkippableInputX</bpmn2:targetRef>
        <bpmn2:assignment>
          <bpmn2:from xsi:type="bpmn2:tFormalExpression">true</bpmn2:from>
          <bpmn2:to xsi:type="bpmn2:tFormalExpression">UserTask_1_SkippableInputX</bpmn2:to>
        </bpmn2:assignment>
      </bpmn2:dataInputAssociation>
      <bpmn2:dataInputAssociation>
        <bpmn2:targetRef>UserTask_1_PriorityInputX</bpmn2:targetRef>
        <bpmn2:assignment>
          <bpmn2:from xsi:type="bpmn2:tFormalExpression">1</bpmn2:from>
          <bpmn2:to xsi:type="bpmn2:tFormalExpression">UserTask_1_PriorityInputX</bpmn2:to>
        </bpmn2:assignment>
      </bpmn2:dataInputAssociation>
    </bpmn2:userTask>
    <bpmn2:endEvent id="EndEvent_1" name="End Event 1">
      <bpmn2:extensionElements>
        <drools:metaData name="elementname">
          <drools:metaValue>End Event 1</drools:metaValue>
        </drools:metaData>
      </bpmn2:extensionElements>
      <bpmn2:incoming>SequenceFlow_4</bpmn2:incoming>
    </bpmn2:endEvent>
    <bpmn2:endEvent id="EndEvent_2" name="End Event 2">
      <bpmn2:extensionElements>
        <drools:metaData name="elementname">
          <drools:metaValue>End Event 2</drools:metaValue>
        </drools:metaData>
      </bpmn2:extensionElements>
      <bpmn2:incoming>SequenceFlow_5</bpmn2:incoming>
    </bpmn2:endEvent>
  </bpmn2:process>
  <bpmndi:BPMNDiagram>
    <bpmndi:BPMNPlane bpmnElement="persons">
      <bpmndi:BPMNShape id="shape_EndEvent_2" bpmnElement="EndEvent_2">
        <dc:Bounds height="56" width="56" x="622" y="201"/>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="shape_EndEvent_1" bpmnElement="EndEvent_1">
        <dc:Bounds height="56" width="56" x="622" y="105"/>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="shape_UserTask_1" bpmnElement="UserTask_1">
        <dc:Bounds height="78" width="134" x="449" y="94"/>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="shape_ExclusiveGateway_1" bpmnElement="ExclusiveGateway_1">
        <dc:Bounds height="56" width="56" x="365" y="105"/>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="shape_BusinessRuleTask_1" bpmnElement="BusinessRuleTask_1">
        <dc:Bounds height="71" width="141" x="180" y="97"/>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="shape_StartEvent_1" bpmnElement="StartEvent_1">
        <dc:Bounds height="56" width="56" x="80" y="105"/>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNEdge id="edge_shape_ExclusiveGateway_1_to_shape_EndEvent_2" bpmnElement="SequenceFlow_5">
        <di:waypoint x="390" y="155"/>
        <di:waypoint x="393" y="231"/>
        <di:waypoint x="622" y="219"/>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="edge_shape_UserTask_1_to_shape_EndEvent_1" bpmnElement="SequenceFlow_4">
        <di:waypoint x="583" y="133"/>
        <di:waypoint x="622" y="123"/>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="edge_shape_ExclusiveGateway_1_to_shape_UserTask_1" bpmnElement="SequenceFlow_3">
        <di:waypoint x="415" y="130"/>
        <di:waypoint x="449" y="133"/>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="edge_shape_BusinessRuleTask_1_to_shape_ExclusiveGateway_1" bpmnElement="SequenceFlow_2">
        <di:waypoint x="321" y="132.5"/>
        <di:waypoint x="365" y="130"/>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="edge_shape_StartEvent_1_to_shape_BusinessRuleTask_1" bpmnElement="SequenceFlow_1">
        <di:waypoint x="116" y="123"/>
        <di:waypoint x="180" y="132.5"/>
      </bpmndi:BPMNEdge>
    </bpmndi:BPMNPlane>
  </bpmndi:BPMNDiagram>
  <bpmn2:relationship type="BPSimData">
    <bpmn2:extensionElements>
      <bpsim:BPSimData>
        <bpsim:Scenario id="default" name="Simulationscenario">
          <bpsim:ScenarioParameters/>
          <bpsim:ElementParameters elementRef="UserTask_1">
            <bpsim:TimeParameters>
              <bpsim:ProcessingTime>
                <bpsim:NormalDistribution mean="0" standardDeviation="0"/>
              </bpsim:ProcessingTime>
            </bpsim:TimeParameters>
            <bpsim:ResourceParameters>
              <bpsim:Availability>
                <bpsim:FloatingParameter value="0"/>
              </bpsim:Availability>
              <bpsim:Quantity>
                <bpsim:FloatingParameter value="0"/>
              </bpsim:Quantity>
            </bpsim:ResourceParameters>
            <bpsim:CostParameters>
              <bpsim:UnitCost>
                <bpsim:FloatingParameter value="0"/>
              </bpsim:UnitCost>
            </bpsim:CostParameters>
          </bpsim:ElementParameters>
          <bpsim:ElementParameters elementRef="BusinessRuleTask_1">
            <bpsim:TimeParameters>
              <bpsim:ProcessingTime>
                <bpsim:NormalDistribution mean="0" standardDeviation="0"/>
              </bpsim:ProcessingTime>
            </bpsim:TimeParameters>
            <bpsim:ResourceParameters>
              <bpsim:Availability>
                <bpsim:FloatingParameter value="0"/>
              </bpsim:Availability>
              <bpsim:Quantity>
                <bpsim:FloatingParameter value="0"/>
              </bpsim:Quantity>
            </bpsim:ResourceParameters>
            <bpsim:CostParameters>
              <bpsim:UnitCost>
                <bpsim:FloatingParameter value="0"/>
              </bpsim:UnitCost>
            </bpsim:CostParameters>
          </bpsim:ElementParameters>
          <bpsim:ElementParameters elementRef="StartEvent_1">
            <bpsim:TimeParameters>
              <bpsim:ProcessingTime>
                <bpsim:NormalDistribution mean="0" standardDeviation="0"/>
              </bpsim:ProcessingTime>
            </bpsim:TimeParameters>
          </bpsim:ElementParameters>
        </bpsim:Scenario>
      </bpsim:BPSimData>
    </bpmn2:extensionElements>
    <bpmn2:source>_J4ElsVJgEDiScotxwBQ14Q</bpmn2:source>
    <bpmn2:target>_J4ElsVJgEDiScotxwBQ14Q</bpmn2:target>
  </bpmn2:relationship>
</bpmn2:definitions>
----

To create this example BPMN process in VS Code using the {PRODUCT_SHORT} BPMN Editor, follow these steps:

.. Open the empty `PersonProcess.bpmn2` file and in the upper-right corner of the {PRODUCT_SHORT} BPMN Editor, click the *Properties* icon and define the following properties:
* *Process*: Set the following values:
** *Name*: `Person Process`
** *ID*: `persons`
** *Package*: `org.acme`
* *Process Data*: Add the following process variables:
** `person` with the type `org.acme.Person` (Use the *Custom* data type option to define the custom type.)
** `isAdult` with the type `Boolean`
.. In the left palette, select *Activities* -> *Business Rule*, drag the task to the diagram, and link to it from the start event.
.. Select the business rule task and define the following properties:

* *General*: Set the rule task *Name* to `Evaluate person`.
* *Implementation/Execution*: Set the following values:
** *Rule Language*: `DMN`
** *Namespace*: The `namespace` property value from the `PersonDecisions.dmn` file that you created previously, such as `\https://kiegroup.org/dmn/_52CEF9FD-9943-4A89-96D5-6F66810CA4C1`
** *DMN Model Name*: `PersonDecisions`
* *Data Assignments*: Add the following assignments:
** *Data Input*: Add a data input with the name `Person`, with the type `org.acme.Person`, and with the source `person`.
** *Data Output*: Add a data output with the name `isAdult`, with the type `Boolean`, and with the source `isAdult`.
.. In the left palette, select *Gateways* -> *Exclusive*, drag the gateway to the diagram, and link to it from the rule task.
.. In the left palette, select *Activities* -> *User*, drag the user task to the diagram, and link to it from the exclusive gateway.
.. Select the user task and define the following properties:

* *General*: Set the user task *Name* to `Special handling for children`.
* *Implementation/Execution*: Set the *Task Name* to `ChildrenHandling`, and add a data input with the name `person`, the type `org.acme.Person`, and the source `person`.
.. In the left palette, select *End Events* -> *End*, drag two end events to the diagram, and link to one end event from the user task and to the other end event from the exclusive gateway.
.. Select the connector that connects the exclusive gateway to the end event and for the *Implementation/Execution* property, set the *Condition Expression* to `Java` and enter the condition `return isAdult == true;`.
.. Select the connector that connects the exclusive gateway to the user task and for the *Implementation/Execution* property, set the *Condition Expression* to `Java` and enter the condition to `return isAdult == false;`.
.. Save the BPMN process file.
--

[id="proc-kogito-designing-app-rule-units"]
=== Using DRL rule units as an alternative decision service

[role="_abstract"]
As an alternative to using Decision Model and Notation (DMN) to define this example decision service, you can also use a Drools Rule Language (DRL) file implemented as a rule unit.

A DRL rule unit is a module for rules and a unit of execution. A rule unit collects a set of rules with the declaration of the type of facts that the rules act on. A rule unit also serves as a unique namespace for each group of rules. A single rule base can contain multiple rule units. You typically store all the rules for a unit in the same file as the unit declaration so that the unit is self-contained.

.Procedure
. In the `src/main/resources` folder of your example {PRODUCT} project, instead of using a DMN file, add the following `PersonRules.drl` file:
+
--
.Example `PersonRules` DRL file
[source,subs="attributes+"]
----
package org.acme
unit PersonRules;

import org.acme.Person;

rule isAdult
	when
		$person: /person[ age > 18 ]
	then
    modify($person) {
    	setAdult(true)
    };
end
----

This example rule determines that any person who is older than 18 is classified as an adult. The rule file also declares that the rule belongs to the rule unit `PersonRules`. This is the rule unit that you define as part of the business rule task in the example BPMN process. When you build the project, the rule unit is generated and associated with the DRL file.

The rule also defines the condition using OOPath notation. OOPath is an object-oriented syntax extension to XPath for navigating through related elements while handling collections and filtering constraints.

You can also rewrite the same rule condition in a more explicit form using the traditional rule pattern syntax, as shown in the following example:

.Example `PersonRules` DRL file using traditional notation
[source,subs="attributes+"]
----
package org.acme
unit PersonRules;

import org.acme.Person;

rule isAdult
	when
		$person: Person(age > 18) from person
	then
    modify($person) {
    	setAdult(true)
    };
end
----
--
. In the `src/main/resources` folder, use the {PRODUCT_SHORT} BPMN Editor in VS Code to open the `PersonProcess.bpmn2` process diagram that you created.
. Select the `Evaluate person` business rule task and modify the following properties:

* *Implementation/Execution*: Set the following values:
** *Rule Language*: `DRL` (instead of `DMN`)
** *Rule Flow Group*: `unit:org.acme.PersonRules`
+
This rule unit syntax in the *Rule Flow Group* field specifies that you are using the `org.acme.PersonRules` rule unit instead of a traditional rule flow group. This is the rule unit that you referenced in the example DRL file. When you build the project, the business process implicitly declares the rule unit as part of the business rule task to execute the DRL file.
* *Data Assignments*: Open the assignment settings and change the data input *Name* to `person` (instead of `Person`). This accommodates the input variable syntax required by the DRL file.
. Select the connector that connects the exclusive gateway to the end event and for the *Implementation/Execution* property, verify that the *Condition Expression* is set to `Java` and change the condition to `return person.isAdult();`.
. Select the connector that connects the exclusive gateway to the user task and for the *Implementation/Execution* property, verify that the *Condition Expression* is set to `Java` and change the condition `return ! person.isAdult();`.
. Save the process file to update the model.

[id="proc-kogito-testing-decision-logic"]
== Testing the decision logic for a {PRODUCT} service using test scenarios

[role="_abstract"]
As you develop business decisions in your {PRODUCT} services, you can use test scenarios to validate the functionality of your decisions before you begin running and using your {PRODUCT} services. With a test scenario, you use data from your project to set given conditions and expected results based on one or more defined business decisions. When you run the scenario, the expected results and actual results of the decision instance are compared. If the expected results match the actual results, the test is successful. If the expected results do not match the actual results, then the test fails.

You define test scenarios in `.scesim` (scenario simulation) files that you can model in Visual Studio Code (VS Code) using {DEV_TOOLS_VSCODE_MARKETPLACE_LINK}[*{DEV_TOOLS}*]. You can use one or multiple `.scesim` files in your {PRODUCT} project, and each `.scesim` file can contain one or multiple test scenarios based on the defined decision data.

The example for this procedure uses a basic `PersonDecisionsTest.scesim` test scenario file that validates the decision logic in the example `PersonDecisions.dmn` Decision Model and Notation (DMN) model that you created previously.

IMPORTANT: Test scenarios in {PRODUCT} currently support DMN decision services only. Test scenarios will support Drools Rule Language (DRL) decision services in a future release.

.Prerequisites
* You have created the `PersonDecisions.dmn` DMN model that determines whether a specified person is an adult or is underage.

.Procedure
. In the Maven project that contains your {PRODUCT} decision services, add the following dependency to the `pom.xml` file to enable test scenario execution for your project:
+
.Dependency to enable test scenario execution
[source,xml]
----
<dependency>
  <groupId>org.kie.kogito</groupId>
  <artifactId>kogito-scenario-simulation</artifactId>
  <scope>test</scope>
</dependency>
----
. Navigate to the `src/main` folder of the project and create a `test` folder with the following subfolders. If you have an existing `test` folder structure, you can adapt the steps that follow according to your project layout.
+
.Test folder structure for test scenarios
[source]
----
src/main/test/
          └── java/testscenario
          └── resources
----
. Navigate to the `test/java/testscenario` folder and add the following `KogitoScenarioJunitActivatorTest.java` class:
+
--
.Activator class for test scenarios
[source,java]
----
package testscenario;

@org.junit.runner.RunWith(org.kogito.scenariosimulation.runner.KogitoJunitActivator.class)
public class KogitoScenarioJunitActivatorTest { }
----

This activator class is a custom https://junit.org/junit5/[JUnit 5] runner that enables the execution of test scenario files in your {PRODUCT} project. When you run test scenarios, this class loads all `.scesim` files available in the project and executes them. For each row (scenario) in a test scenario file, the activator class generates a JUnit test result.
--
. Navigate to the `test/resources` folder and add the following `PersonDecisionsTest.scesim` test scenario file:
+
--
.Example test scenarios for `PersonDecisions` DMN decision logic
image::kogito-test-scenario-example-person.png[Image of PersonDecisionsTest test scenario]

The *GIVEN* columns specify input conditions based on the corresponding decision service. The *EXPECT* column specifies the expected results of the decision service based on the defined *GIVEN* conditions. Each row in the table is a defined scenario with example values for the *GIVEN* and *EXPECT* definitions to test the decision logic of the corresponding decision service.

This example test scenario file tests the decision logic for the following `PersonDecisions.dmn` model that you created previously. This DMN model determines whether a specified person is an adult or is underage.

.Example `PersonDecisions` DMN decision requirements diagram (DRD)
image::kogito-dmn-example-person.png[Image of PersonDecisions decision diagram]

.Example DMN boxed expression for `isAdult` decision
image::kogito-dmn-example-person-logic.png[Image of PersonDecisions Decision Table]

In VS Code, you can add the {DEV_TOOLS_VSCODE_MARKETPLACE_LINK}[*{DEV_TOOLS}*] to design the test scenarios with the test scenario modeler.

To create these example test scenarios quickly, you can copy the following `PersonDecisionsTest.scesim` file content:

.Example test scenario file
[source,xml]
----
<ScenarioSimulationModel version="1.8">
  <simulation>
    <scesimModelDescriptor>
      <factMappings>
        <FactMapping>
          <expressionElements/>
          <expressionIdentifier>
            <name>Index</name>
            <type>OTHER</type>
          </expressionIdentifier>
          <factIdentifier>
            <name>#</name>
            <className>java.lang.Integer</className>
          </factIdentifier>
          <className>java.lang.Integer</className>
          <factAlias>#</factAlias>
          <columnWidth>70</columnWidth>
          <factMappingValueType>NOT_EXPRESSION</factMappingValueType>
        </FactMapping>
        <FactMapping>
          <expressionElements/>
          <expressionIdentifier>
            <name>Description</name>
            <type>OTHER</type>
          </expressionIdentifier>
          <factIdentifier>
            <name>Scenario description</name>
            <className>java.lang.String</className>
          </factIdentifier>
          <className>java.lang.String</className>
          <factAlias>Scenario description</factAlias>
          <columnWidth>300</columnWidth>
          <factMappingValueType>NOT_EXPRESSION</factMappingValueType>
        </FactMapping>
        <FactMapping>
          <expressionElements>
            <ExpressionElement>
              <step>Person</step>
            </ExpressionElement>
            <ExpressionElement>
              <step>Age</step>
            </ExpressionElement>
          </expressionElements>
          <expressionIdentifier>
            <name>1|1</name>
            <type>GIVEN</type>
          </expressionIdentifier>
          <factIdentifier>
            <name>Person</name>
            <className>Person</className>
          </factIdentifier>
          <className>number</className>
          <factAlias>Person</factAlias>
          <expressionAlias>Age</expressionAlias>
          <genericTypes/>
          <columnWidth>114</columnWidth>
          <factMappingValueType>NOT_EXPRESSION</factMappingValueType>
        </FactMapping>
        <FactMapping>
          <expressionElements>
            <ExpressionElement>
              <step>Person</step>
            </ExpressionElement>
            <ExpressionElement>
              <step>Name</step>
            </ExpressionElement>
          </expressionElements>
          <expressionIdentifier>
            <name>1|2</name>
            <type>GIVEN</type>
          </expressionIdentifier>
          <factIdentifier>
            <name>Person</name>
            <className>Person</className>
          </factIdentifier>
          <className>string</className>
          <factAlias>Person</factAlias>
          <expressionAlias>Name</expressionAlias>
          <genericTypes/>
          <columnWidth>114</columnWidth>
          <factMappingValueType>NOT_EXPRESSION</factMappingValueType>
        </FactMapping>
        <FactMapping>
          <expressionElements>
            <ExpressionElement>
              <step>isAdult</step>
            </ExpressionElement>
          </expressionElements>
          <expressionIdentifier>
            <name>1|4</name>
            <type>EXPECT</type>
          </expressionIdentifier>
          <factIdentifier>
            <name>isAdult</name>
            <className>isAdult</className>
          </factIdentifier>
          <className>boolean</className>
          <factAlias>isAdult</factAlias>
          <expressionAlias>value</expressionAlias>
          <genericTypes/>
          <columnWidth>114</columnWidth>
          <factMappingValueType>NOT_EXPRESSION</factMappingValueType>
        </FactMapping>
      </factMappings>
    </scesimModelDescriptor>
    <scesimData>
      <Scenario>
        <factMappingValues>
          <FactMappingValue>
            <factIdentifier>
              <name>Scenario description</name>
              <className>java.lang.String</className>
            </factIdentifier>
            <expressionIdentifier>
              <name>Description</name>
              <type>OTHER</type>
            </expressionIdentifier>
            <rawValue class="string">Is an adult</rawValue>
          </FactMappingValue>
          <FactMappingValue>
            <factIdentifier>
              <name>Person</name>
              <className>Person</className>
            </factIdentifier>
            <expressionIdentifier>
              <name>1|1</name>
              <type>GIVEN</type>
            </expressionIdentifier>
            <rawValue class="string">20</rawValue>
          </FactMappingValue>
          <FactMappingValue>
            <factIdentifier>
              <name>Person</name>
              <className>Person</className>
            </factIdentifier>
            <expressionIdentifier>
              <name>1|2</name>
              <type>GIVEN</type>
            </expressionIdentifier>
            <rawValue class="string">"John Quark"</rawValue>
          </FactMappingValue>
          <FactMappingValue>
            <factIdentifier>
              <name>isAdult</name>
              <className>isAdult</className>
            </factIdentifier>
            <expressionIdentifier>
              <name>1|4</name>
              <type>EXPECT</type>
            </expressionIdentifier>
            <rawValue class="string">true</rawValue>
          </FactMappingValue>
          <FactMappingValue>
            <factIdentifier>
              <name>#</name>
              <className>java.lang.Integer</className>
            </factIdentifier>
            <expressionIdentifier>
              <name>Index</name>
              <type>OTHER</type>
            </expressionIdentifier>
            <rawValue class="string">1</rawValue>
          </FactMappingValue>
        </factMappingValues>
      </Scenario>
      <Scenario>
        <factMappingValues>
          <FactMappingValue>
            <factIdentifier>
              <name>Scenario description</name>
              <className>java.lang.String</className>
            </factIdentifier>
            <expressionIdentifier>
              <name>Description</name>
              <type>OTHER</type>
            </expressionIdentifier>
            <rawValue class="string">Is underage</rawValue>
          </FactMappingValue>
          <FactMappingValue>
            <factIdentifier>
              <name>Person</name>
              <className>Person</className>
            </factIdentifier>
            <expressionIdentifier>
              <name>1|1</name>
              <type>GIVEN</type>
            </expressionIdentifier>
            <rawValue class="string">15</rawValue>
          </FactMappingValue>
          <FactMappingValue>
            <factIdentifier>
              <name>Person</name>
              <className>Person</className>
            </factIdentifier>
            <expressionIdentifier>
              <name>1|2</name>
              <type>GIVEN</type>
            </expressionIdentifier>
            <rawValue class="string">"Jenny Quark"</rawValue>
          </FactMappingValue>
          <FactMappingValue>
            <factIdentifier>
              <name>isAdult</name>
              <className>isAdult</className>
            </factIdentifier>
            <expressionIdentifier>
              <name>1|4</name>
              <type>EXPECT</type>
            </expressionIdentifier>
            <rawValue class="string">false</rawValue>
          </FactMappingValue>
          <FactMappingValue>
            <factIdentifier>
              <name>#</name>
              <className>java.lang.Integer</className>
            </factIdentifier>
            <expressionIdentifier>
              <name>Index</name>
              <type>OTHER</type>
            </expressionIdentifier>
            <rawValue class="string">2</rawValue>
          </FactMappingValue>
        </factMappingValues>
      </Scenario>
    </scesimData>
  </simulation>
  <background>
    <scesimModelDescriptor>
      <factMappings>
        <FactMapping>
          <expressionElements/>
          <expressionIdentifier>
            <name>1|1</name>
            <type>GIVEN</type>
          </expressionIdentifier>
          <factIdentifier>
            <name>Empty</name>
            <className>java.lang.Void</className>
          </factIdentifier>
          <className>java.lang.Void</className>
          <factAlias>INSTANCE 1</factAlias>
          <expressionAlias>PROPERTY 1</expressionAlias>
          <columnWidth>114</columnWidth>
          <factMappingValueType>NOT_EXPRESSION</factMappingValueType>
        </FactMapping>
      </factMappings>
    </scesimModelDescriptor>
    <scesimData>
      <BackgroundData>
        <factMappingValues>
          <FactMappingValue>
            <factIdentifier>
              <name>Empty</name>
              <className>java.lang.Void</className>
            </factIdentifier>
            <expressionIdentifier>
              <name>1|1</name>
              <type>GIVEN</type>
            </expressionIdentifier>
          </FactMappingValue>
        </factMappingValues>
      </BackgroundData>
    </scesimData>
  </background>
  <settings>
    <dmnFilePath>src/main/resources/PersonDecisions.dmn</dmnFilePath>
    <type>DMN</type>
    <dmnNamespace>https://kiegroup.org/dmn/_52CEF9FD-9943-4A89-96D5-6F66810CA4C1</dmnNamespace>
    <dmnName>PersonDecisions</dmnName>
    <skipFromBuild>false</skipFromBuild>
    <stateless>false</stateless>
  </settings>
  <imports>
    <imports/>
  </imports>
</ScenarioSimulationModel>
----

To create this example test scenario file in VS Code using the {PRODUCT} test scenario modeler, follow these steps:

.. Open the empty `PersonDecisionsTest.scesim` file and in the *Create Test Scenario* window that appears, set the *Source type* to *DMN*, select the `PersonDecisions.dmn` DMN model from the drop-down options, and click *Create*.
+
.Create test scenario definition
image::kogito-test-scenario-example-person-create.png[Image of Create Test Scenario window]
+
The test scenario modeler automatically generates a scenario template based on the available DMN data types and fields that you defined in the DMN model.
+
You can right-click the relevant header cells to insert or delete columns as needed to modify the table structure. You can also select the relevant header cells to modify or insert data objects from the *Test Tools* panel in the right toolbar.
.. For this example, modify the generated test scenario header cells and specified data objects as needed to create the following test scenario template. Use the *Test Tools* panel in the right toolbar to select and insert the data objects as needed. Many of the header cell values might already be defined for you.
+
* *GIVEN*: Verify that the first header cell (instance) is set to the *Person* data object and that the subheader cells (properties) are set to the *Age* and *Name* data objects. Delete any other columns under *GIVEN* that were automatically generated, if applicable.
* *EXPECT*: Verify that the first header cell (instance) is set to the *isAdult* data object and that the subheader cell (property) is set to the *value* data object. Delete any other columns under *EXPECT* that were automatically generated, if applicable.
+
.Define test scenario header cells
image::kogito-test-scenario-example-person-headers-create.png[Image of test scenario template]
.. In row 1, create a test scenario with the following values:
+
* *Scenario description*: `Is an adult`
* *GIVEN*: Set the following values:
** *Person* -> *Age*: `20`
** *Person* -> *Name*: `John Quark`
* *EXPECT*: Set the following value:
** *isAdult* -> *value*: `true`

+
This example scenario tests whether the person John Quark with 20 years of age is correctly identified by the `isAdult` DMN decision as an adult (`true`), based on the decision logic that adults are more than 18 years old.
.. Right-click any cell in row 1, select *Insert row below*, and in row 2, create another test scenario with the following values:
+
* *Scenario description*: `Is underage`
* *GIVEN*: Set the following values:
** *Person* -> *Age*: `15`
** *Person* -> *Name*: `Jenny Quark`
* *EXPECT*: Set the following value:
** *isAdult* -> *value*: `false`

+
This example scenario tests whether the person Jenny Quark with 15 years of age is correctly identified by the `isAdult` DMN decision as not an adult (`false`), based on the decision logic that adults are more than 18 years old.
.. Save the test scenario file.
--
. After you define and save the test scenarios, in a command terminal, navigate to the project that contains your {PRODUCT} decision service and test scenarios and enter the following command to run the test scenarios:
+
--
.Run the test scenarios
[source]
----
mvn clean test
----

A summary of the test scenario execution appears in the command terminal, and detailed reports are generated in the `target/surefire-reports` folder of your {PRODUCT} project.

In the following example output, the test scenarios were executed successfully and encountered no errors:

.Terminal output for successful test scenarios
[source]
----
[INFO] --- maven-surefire-plugin:2.22.1:test (default-test) @ sample-kogito ---
[INFO]
[INFO] -------------------------------------------------------
[INFO]  T E S T S
[INFO] -------------------------------------------------------
[INFO] Running testscenario.KogitoScenarioJunitActivatorTest
./target/classes/PersonDecisions.dmn
./src/main/resources/PersonDecisions.dmn
./target/classes/PersonDecisions.dmn
./src/main/resources/PersonDecisions.dmn
[INFO] Tests run: 2, Failures: 0, Errors: 0, Skipped: 0, Time elapsed: 0.535 s - in testscenario.KogitoScenarioJunitActivatorTest
[INFO]
[INFO] Results:
[INFO]
[INFO] Tests run: 2, Failures: 0, Errors: 0, Skipped: 0
[INFO]
[INFO] ------------------------------------------------------------------------
[INFO] BUILD SUCCESS
[INFO] ------------------------------------------------------------------------
[INFO] Total time:  52.884 s
[INFO] Finished at: 2020-05-05T15:19:53-04:00
[INFO] ------------------------------------------------------------------------
----

The expected results defined in the test scenarios matched the actual results of the `isAdult` DMN decision instance in the `PersonDecisions.dmn` file. This match of expected and actual results for the decision instance means that the decision logic functions as intended.

In the following example output, the test scenarios were executed and the `Is underage` scenario encountered an error:

.Terminal output for a test scenario that encountered a decision error
[source]
----
[INFO] --- maven-surefire-plugin:2.22.1:test (default-test) @ sample-kogito ---
[INFO]
[INFO] -------------------------------------------------------
[INFO]  T E S T S
[INFO] -------------------------------------------------------
[INFO] Running testscenario.KogitoScenarioJunitActivatorTest
./target/classes/PersonDecisions.dmn
./src/main/resources/PersonDecisions.dmn
./target/classes/PersonDecisions.dmn
./src/main/resources/PersonDecisions.dmn
[ERROR] Tests run: 2, Failures: 0, Errors: 1, Skipped: 0, Time elapsed: 0.534 s <<< FAILURE! - in testscenario.KogitoScenarioJunitActivatorTest
[ERROR] #2: Is underage  Time elapsed: 0.06 s  <<< ERROR!
org.drools.scenariosimulation.backend.runner.IndexedScenarioException: #2: Scenario 'Is underage' failed(/home/jsmith/sample-kogito/target/test-classes/PersonDecisionsTest.scesim)
Caused by: org.drools.scenariosimulation.backend.runner.ScenarioException: Scenario 'Is underage' failed

[INFO]
[INFO] Results:
[INFO]
[ERROR] Errors:
[ERROR]   KogitoScenarioJunitActivatorTest » IndexedScenario #2: Scenario 'Is underage' ...
[INFO]
[ERROR] Tests run: 2, Failures: 0, Errors: 1, Skipped: 0
[INFO]
[INFO] ------------------------------------------------------------------------
[INFO] BUILD FAILURE
[INFO] ------------------------------------------------------------------------
[INFO] Total time:  6.521 s
[INFO] Finished at: 2020-05-05T15:26:10-04:00
[INFO] ------------------------------------------------------------------------
[ERROR] Failed to execute goal org.apache.maven.plugins:maven-surefire-plugin:2.22.1:test (default-test) on project sample-kogito: There are test failures.
[ERROR]
[ERROR] Please refer to /home/jsmith/sample-kogito/target/surefire-reports for the individual test results.
[ERROR] Please refer to dump files (if any exist) [date].dump, [date]-jvmRun[N].dump and [date].dumpstream.
----

The expected results defined in the `Is underage` test scenario did not match the actual results of the `isAdult` DMN decision instance in the `PersonDecisions.dmn` file. This mismatch of expected and actual results for the decision instance means that either the test scenario identified a flaw in the decision logic or the test scenario is incorrectly defined. In this case, the `Is underage` test scenario was intentionally modified incorrectly with an age of `20` instead of an age of `18` or less. Reverting the age to `15` as shown in the previous example resolves the error.
--

[id="proc-kogito-running-app"]
== Running a {PRODUCT} service

[role="_abstract"]
After you design the business decisions and processes for your {PRODUCT} service, you can run your Quarkus application in one of the following modes:

* *Development mode*: For local testing. On Quarkus, development mode also offers live reload of your processes and decisions in your running applications for advanced debugging.
* *JVM mode*: For compatibility with a Java virtual machine (JVM).
* *Native mode*: (Quarkus only, requires GraalVM or Mandrel) For direct binary execution as native code.

.Procedure
In a command terminal, navigate to the project that contains your {PRODUCT} service and enter one of the following commands, depending on your preferred run mode and application environment:

* For development mode:
+
--
.On Quarkus
[source]
----
$ mvn clean compile quarkus:dev
----
--
* For JVM mode:
+
--
.On Quarkus
[source]
----
$ mvn clean package
$ java -jar target/quarkus-app/quarkus-run.jar
----
--

* For native mode (requires GraalVM):
+
--
.On Quarkus only
[source]
----
$ mvn clean package -Dnative
$ ./target/sample-kogito-1.0-SNAPSHOT-runner
----
--

[NOTE]
========

Alternatively, you can use a container builder image. You do not need to install GraalVM because a container containing GraalVM is pulled automatically. Note that the executable targets a Linux kernel by default. For example:

--
.On Quarkus only (GraalVM native build using container)
[source]
----
$ mvn clean package -Dnative -Dquarkus.native.container-build
----
--

To use Mandrel instead of GraalVM, run the following command:

--
.On Quarkus only (Mandrel native build using container)
[source]
----
$ mvn clean package -Dnative -Dquarkus.native.container-build -Dquarkus.native.builder-image=quay.io/quarkus/ubi-quarkus-mandrel:21.1-java11
----
--

========


For further information about building a native image, see https://quarkus.io/guides/building-native-image#container-runtime[Quarkus - Building a Native Executable].

[id="proc-kogito-interacting-app"]
== Interacting with a running {PRODUCT} service

[role="_abstract"]
After your {PRODUCT} service is running, you can send REST API requests to interact with your application and execute your services according to how you set up the application.

This example tests the `/persons` REST API endpoint that is automatically generated based on the `PersonProcess.bpmn2` business process, according to the decisions in the `PersonDecisions.dmn` file (or the rules in the `PersonRules.drl` file if you used a DRL rule unit).

For this example, use a REST client, curl utility, or the Swagger UI configured for the application (such as \http://localhost:8080/q/swagger-ui or \http://localhost:8080/swagger-ui.html) to send API requests with the following components:

* *URL*: `\http://localhost:8080/persons`
* *HTTP headers*: For `POST` requests only:
** `accept`: `application/json`
** `content-type`: `application/json`
* *HTTP methods*: `GET`, `POST`, or `DELETE`

.Example POST request body to add an adult (JSON)
[source,json]
----
{
  "person": {
    "name": "John Quark",
    "age": 20
  }
}
----

.Example curl command to add an adult
[source]
----
curl -X POST http://localhost:8080/persons -H 'content-type: application/json' -H 'accept: application/json' -d '{"person": {"name":"John Quark", "age": 20}}'
----

.Example response (JSON)
[source,json]
----
{
  "id": "3af806dd-8819-4734-a934-728f4c819682",
  "person": {
    "name": "John Quark",
    "age": 20,
    "adult": false
  },
  "isAdult": true
}
----

.Swagger UI to interact with all application endpoints (such as \http://localhost:8080/q/swagger-ui or \http://localhost:8080/swagger-ui.html)
image::kogito-swagger-example.png[Image of Swagger UI for example application]

This example procedure uses curl commands for convenience.

.Procedure
In a command terminal window that is separate from your running application, navigate to the project that contains your {PRODUCT} service and use any of the following curl commands with JSON requests to interact with your running service:

* Add an adult person:
+
--
.Example request
[source]
----
curl -X POST http://localhost:8080/persons -H 'content-type: application/json' -H 'accept: application/json' -d '{"person": {"name":"John Quark", "age": 20}}'
----

.Example response
[source]
----
{"id":"3af806dd-8819-4734-a934-728f4c819682","person":{"name":"John Quark","age":20,"adult":false},"isAdult":true}
----
--
* Add an underage person:
+
--
.Example request
[source]
----
curl -X POST http://localhost:8080/persons -H 'content-type: application/json' -H 'accept: application/json' -d '{"person": {"name":"Jenny Quark", "age": 15}}'
----

.Example response
[source]
----
{"id":"8eef502b-012b-4628-acb7-73418a089c08","person":{"name":"Jenny Quark","age":15,"adult":false},"isAdult":false}
----
--
* View active process instances:
+
--
.Example request
[source]
----
curl -X GET http://localhost:8080/persons -H 'content-type: application/json' -H 'accept: application/json'
----

.Example response
[source]
----
[{"id":"8eef502b-012b-4628-acb7-73418a089c08","person":{"name":"Jenny Quark","age":15,"adult":false},"isAdult":false}]
----
--
* View process instance details using the returned process UUID:
+
--
.Example request
[source]
----
curl -X GET http://localhost:8080/persons/8eef502b-012b-4628-acb7-73418a089c08/tasks -H 'content-type: application/json' -H 'accept: application/json'
----

.Example response (JSON)
[source]
----
{"cdec4241-d676-47de-8c55-4ee4f9598bac":"ChildrenHandling"}
----
--
* View task instance details using the returned process and task UUIDs:
+
--
.Example request
[source]
----
curl -X GET http://localhost:8080/persons/8eef502b-012b-4628-acb7-73418a089c08/ChildrenHandling/cdec4241-d676-47de-8c55-4ee4f9598bac -H 'content-type: application/json' -H 'accept: application/json'
----

.Example response
[source]
----
{"person":{"name":"Jenny Quark","age":15,"adult":false},"name":"ChildrenHandling","id":"cdec4241-d676-47de-8c55-4ee4f9598bac"}
----
--
* Complete the evaluation using the returned UUIDs:
+
--
.Example request
[source]
----
curl -X POST http://localhost:8080/persons/8eef502b-012b-4628-acb7-73418a089c08/ChildrenHandling/cdec4241-d676-47de-8c55-4ee4f9598bac -H 'content-type: application/json' -H 'accept: application/json' -d '{}'
----
--

